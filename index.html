<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Inventory Advance 2025 - Full Fixed (v2)</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/exceljs@4.3.0/dist/exceljs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sql.js@1.8.0/dist/sql-wasm.js"></script>
  <style>
    :root{ --primary:#2b7bd3; --secondary:#58a6ff; --success:#27ae60; --danger:#e74c3c; --warning:#f39c12; --bg:#f3f7fb; --card:#fff; --text:#123; --border:#e6f0fb; --radius:12px; --shadow:0 6px 18px rgba(43,123,211,0.06); }
    .dark-theme{ --primary:#58a6ff; --bg:#2c3e50; --card:#34495e; --text:#ecf0f1; --border:#4a5f7a }
    *{box-sizing:border-box;font-family:'Cairo',sans-serif}
    body{margin:0;min-height:100vh;background:var(--bg);color:var(--text)}
    .app-header{background:linear-gradient(90deg,var(--primary),var(--secondary));color:#fff;padding:12px 16px;position:sticky;top:0;z-index:120}
    .header-content{display:flex;justify-content:space-between;align-items:center;gap:12px}
    .logo-area{display:flex;align-items:center;gap:12px}
    .lab-logo{width:72px;height:56px;background:#fff;border-radius:8px;overflow:hidden;display:flex;align-items:center;justify-content:center}
    .lab-logo img{max-width:100%;max-height:100%;object-fit:contain}
    .app-title{font-weight:800}
    .app-sub{font-size:0.85em;opacity:.95}
    .app-nav{display:flex;background:var(--card);border-bottom:1px solid var(--border);position:sticky;top:80px;z-index:100}
    .nav-item{flex:1;text-align:center;padding:10px;font-weight:700;color:#6b7b8a;cursor:pointer;border:none;background:none}
    .nav-item.active{color:var(--primary);border-bottom:3px solid var(--primary)}
    .app-content{padding:16px;padding-bottom:120px}
    .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);margin-bottom:16px}
    .card-header{padding:12px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;font-weight:800}
    .card-body{padding:12px}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:10px;border:none;cursor:pointer;font-weight:700}
    .btn-primary{background:var(--primary);color:#fff}
    .btn-success{background:var(--success);color:#fff}
    .btn-danger{background:var(--danger);color:#fff}
    .btn-warning{background:var(--warning);color:#fff}
    .btn-light{background:var(--card);color:var(--text);border:1px solid var(--border)}
    .btn-outline{background:transparent;border:1px solid var(--primary);color:var(--primary)}
    .form-control{width:100%;padding:10px;border:1px solid var(--border);border-radius:8px;background:#fff;color:var(--text)}
    .form-group{margin-bottom:12px}
    .table{width:100%;border-collapse:collapse;font-size:13px;min-width:600px}
    .table th,.table td{padding:10px;border-bottom:1px solid var(--border);text-align:center}
    .table-img{width:80px;height:60px;object-fit:cover;border-radius:6px}
    .stats-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:12px}
    .stat-card{background:var(--card);padding:12px;border-radius:8px;text-align:center}
    .stat-value{font-size:20px;font-weight:900;color:var(--primary)}
    .image-preview{width:100%;max-width:250px;height:150px;border:2px dashed var(--border);border-radius:10px;display:flex;align-items:center;justify-content:center;background:#fff;margin-bottom:10px;overflow:hidden}
    .signature-preview{width:150px;height:80px;border:1px solid var(--border);margin:0 auto 10px;display:flex;align-items:center;justify-content:center;background:#fff}
    .notification{position:fixed;top:18px;left:18px;right:18px;padding:12px;border-radius:10px;background:var(--success);color:#fff;display:flex;justify-content:space-between;z-index:2000;transform:translateY(-120px);opacity:0;transition:all .25s}
    .notification.show{transform:translateY(0);opacity:1}
    .loading-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.45);display:none;align-items:center;justify-content:center;z-index:3000;color:#fff}
    .loading-overlay.show{display:flex}
    .app-footer{position:fixed;bottom:0;left:0;right:0;background:var(--card);border-top:1px solid var(--border);display:flex;padding:10px 0;z-index:150}
    .footer-btn{flex:1;display:flex;flex-direction:column;align-items:center;gap:5px;background:none;border:none;color:#6b7b8a;cursor:pointer;padding:8px 0}
    .footer-btn.active{color:var(--primary)}
    .page{display:none}
    .page.active{display:block}
    .upload-placeholder{text-align:center;color:#7f8c8d}
    .upload-placeholder i{font-size:24px;margin-bottom:5px}
    .expired{background-color:#ffebee !important}
    .low-stock{background-color:#fff3e0 !important}
    .page-btn{padding:8px 12px;margin:0 4px;border:1px solid var(--border);background:var(--card);cursor:pointer;border-radius:6px}
    .page-btn.active{background:var(--primary);color:#fff;border-color:var(--primary)}
    .pagination{display:flex;justify-content:center;align-items:center;margin-top:16px;gap:6px}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);border:0}
    .close-app-btn{background:var(--danger);color:#fff;border-radius:8px;padding:8px 16px;border:none;cursor:pointer;font-weight:700;margin-right:8px}
    @media(max-width:900px){ .stats-grid{grid-template-columns:repeat(2,1fr)} .table{min-width:100%} }
    @media print{ .app-nav,.app-footer,.btn,.action-buttons,#notification,.loading-overlay{display:none !important} }
    
    /* إضافة ستايل خاص للطباعة في PDF */
    .pdf-export { background: white; color: black; padding: 20px; direction: rtl; font-family: 'Cairo', sans-serif; }
    .pdf-header { text-align: center; margin-bottom: 20px; border-bottom: 2px solid #2b7bd3; padding-bottom: 15px; }
    .pdf-table { width: 100%; border-collapse: collapse; font-size: 12px; margin: 20px 0; }
    .pdf-table th, .pdf-table td { border: 1px solid #ddd; padding: 8px; text-align: center; }
    .pdf-table th { background-color: #2b7bd3; color: white; }
    .pdf-signatures { display: flex; justify-content: space-between; margin-top: 40px; }
    .pdf-footer { text-align: center; margin-top: 30px; font-size: 10px; color: #666; }
  </style>
</head>
<body>
  <div class="app-container">
    <header class="app-header">
      <div class="header-content">
        <div class="logo-area">
          <div class="lab-logo"><img id="labLogoImg" src="assets/logo.png" alt="شعار" onerror="this.style.display='none'"></div>
          <div>
            <div class="app-title">نظام جرد المختبر - Inventory Advance</div>
            <div class="app-sub">نسخة 2025 - متكامل مع SQL و ExcelJS</div>
          </div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <button class="close-app-btn" id="closeAppBtn"><i class="fas fa-power-off"></i> إغلاق</button>
          <button class="btn btn-light" id="toggleThemeBtn" title="تبديل السمة"><i class="fas fa-moon"></i></button>
          <button class="btn btn-outline" id="changeLogoBtn"><i class="fas fa-image"></i> تغيير الشعار</button>
        </div>
      </div>
    </header>

    <nav class="app-nav" role="navigation" aria-label="رئيسي">
      <button class="nav-item active" data-page="inventory">المخزون</button>
      <button class="nav-item" data-page="add">إضافة</button>
      <button class="nav-item" data-page="reports">التقارير</button>
      <button class="nav-item" data-page="settings">الإعدادات</button>
    </nav>

    <main class="app-content">
      <section id="inventory" class="page active" aria-live="polite">
        <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:12px">
          <button class="btn btn-primary" id="btnAdd"><i class="fas fa-plus"></i> إضافة صنف</button>
          <button class="btn btn-success" id="btnExcel"><i class="fas fa-file-excel"></i> تصدير Excel</button>
          <button class="btn btn-danger" id="btnPDF"><i class="fas fa-file-pdf"></i> تصدير PDF</button>
          <button class="btn btn-light" id="btnPrint"><i class="fas fa-print"></i> طباعة</button>
          <button class="btn btn-outline" id="btnExportDB"><i class="fas fa-database"></i> نسخ قاعدة البيانات</button>
        </div>

        <div class="stats-grid" aria-hidden="false">
          <div class="stat-card"><div class="stat-value" id="totalItems">0</div><div class="stat-label">إجمالي الأصناف</div></div>
          <div class="stat-card"><div class="stat-value" id="expiredItems">0</div><div class="stat-label">منتهي الصلاحية</div></div>
          <div class="stat-card"><div class="stat-value" id="lowStockItems">0</div><div class="stat-label">منخفض المخزون</div></div>
          <div class="stat-card"><div class="stat-value" id="totalQuantity">0</div><div class="stat-label">إجمالي الكمية</div></div>
        </div>

        <div class="card" role="region" aria-label="قائمة المخزون">
          <div class="card-header">
            <span style="font-size:16px">قائمة المخزون</span>
            <div class="search-box">
              <input type="text" id="searchInput" class="form-control" placeholder="بحث..." />
            </div>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table" id="inventoryTable" aria-describedby="tableDescription">
                <caption id="tableDescription" class="sr-only">جدول يوضح أصناف المخزون</caption>
                <thead>
                  <tr><th>#</th><th>الصورة</th><th>النوع</th><th>الاسم</th><th>الكمية</th><th>الوحدة</th><th>الانتهاء</th><th>الإجراءات</th></tr>
                </thead>
                <tbody id="inventoryBody"></tbody>
              </table>
            </div>
            <div id="pagination" class="pagination" aria-label="ترقيم الصفحات"></div>
          </div>
        </div>
      </section>

      <section id="add" class="page" aria-hidden="true">
        <div class="card">
          <div class="card-header">
            <span id="formTitle">إضافة صنف جديد</span>
            <button class="btn btn-light" id="backToInventory"><i class="fas fa-arrow-right"></i> رجوع</button>
          </div>
          <div class="card-body">
            <form id="addItemForm">
              <input type="hidden" id="editItemId" value="">
              <div class="form-group">
                <label class="form-label">صورة الصنف</label>
                <div class="image-upload">
                  <div class="image-preview" id="imagePreview"><div class="upload-placeholder"><i class="fas fa-image"></i><div>انقر لرفع صورة</div></div></div>
                  <input type="file" id="imageInput" accept="image/*" style="display:none;">
                  <button type="button" class="btn btn-outline" id="pickImageBtn"><i class="fas fa-upload"></i> رفع صورة</button>
                  <small>الحد الأقصى 2MB. JPG/PNG</small>
                </div>
              </div>

              <div class="form-group"><label class="form-label">نوع المخزون</label>
                <select class="form-control" id="itemType" required>
                  <option value="">اختر النوع</option>
                  <option>مشخصات اليزا</option><option>لقاح</option><option>كاشف</option><option>مصل</option><option>مستنبت</option><option>أخرى</option>
                </select>
              </div>

              <div class="form-group"><label class="form-label">اسم المخزون</label>
                <select class="form-control" id="itemName" required>
                  <option value="">اختر الاسم</option>
                  <option>Rift valley competition elisa</option>
                  <option>FMD NSP competition elisa</option>
                  <option>Bluetongue competition elisa</option>
                  <option>PPR competition elisa</option>
                  <option>RBT rose bengal antigen</option>
                  <option>لقاح الحمى القلاعية</option>
                  <option>لقاح الجدري</option>
                  <option>مصل البروسيلا</option>
                  <option>مستنبت الخلايا</option>
                  <option>أخرى</option>
                </select>
                <input type="text" class="form-control mt-2" id="customItemName" placeholder="أدخل اسم مخصص" style="display:none;">
              </div>

              <div class="form-group"><label class="form-label">الكمية</label><input type="number" class="form-control" id="itemQuantity" min="0" required></div>
              <div class="form-group"><label class="form-label">الوحدة</label>
                <select class="form-control" id="itemUnit" required>
                  <option value="">اختر الوحدة</option><option>باكت</option><option>قارورة</option><option>جرعة</option><option>علبة</option><option>كيس</option><option>لتر</option><option>مللي لتر</option><option>أخرى</option>
                </select>
              </div>
              <div class="form-group"><label class="form-label">تاريخ الانتهاء</label><input type="month" class="form-control" id="itemExpiry" required></div>
              <div class="form-group"><label class="form-label">الشركة المنتجة</label><input type="text" class="form-control" id="itemCompany"></div>
              <div class="form-group"><label class="form-label">رقم التشغيلة</label><input type="text" class="form-control" id="itemBatch"></div>
              <div class="form-group"><label class="form-label">رقم المنتج</label><input type="text" class="form-control" id="itemProduct"></div>
              <div class="form-group"><label class="form-label">ملاحظات</label><textarea class="form-control" id="itemNotes"></textarea></div>

              <div style="display:flex;gap:8px;flex-wrap:wrap">
                <button type="submit" class="btn btn-success"><i class="fas fa-save"></i> حفظ الصنف</button>
                <button type="button" class="btn btn-light" id="resetFormBtn"><i class="fas fa-undo"></i> مسح النموذج</button>
              </div>
            </form>
          </div>
        </div>
      </section>

      <section id="reports" class="page" aria-hidden="true">
        <div class="card"><div class="card-header">التقارير والإحصائيات</div><div class="card-body">
          <div class="stats-grid">
            <div class="stat-card"><div class="stat-value" id="reportTotal">0</div><div class="stat-label">إجمالي الأصناف</div></div>
            <div class="stat-card"><div class="stat-value" id="reportExpired">0</div><div class="stat-label">منتهي الصلاحية</div></div>
            <div class="stat-card"><div class="stat-value" id="reportLowStock">0</div><div class="stat-label">منخفض المخزون</div></div>
            <div class="stat-card"><div class="stat-value" id="reportTypes">0</div><div class="stat-label">عدد الأنواع</div></div>
          </div>
          <div id="reportContent"></div>
        </div></div>
      </section>

      <section id="settings" class="page" aria-hidden="true">
        <div class="card"><div class="card-header">الإعدادات</div><div class="card-body">
          <div class="form-group">
            <label class="form-label">نسخ احتياطي / استيراد</label>
            <div style="display:flex;gap:8px;flex-wrap:wrap"><button class="btn btn-success" id="exportDbBtn"><i class="fas fa-download"></i> تصدير قاعدة البيانات</button><button class="btn btn-primary" id="importDbBtn"><i class="fas fa-upload"></i> استيراد قاعدة بيانات</button></div>
           <input type="file" id="importDatabaseInput" accept=".db,.sqlite" style="display:none">
          </div>

          <div class="form-group"><label class="form-label">تواقيع المسؤولين</label>
            <div style="display:flex;gap:12px;flex-wrap:wrap">
              <div style="min-width:220px">
                <div class="signature-preview" id="directorSignaturePreview"><div class="upload-placeholder"><i class="fas fa-signature"></i><div>توقيع المدير</div></div></div>
                <div style="text-align:center;font-weight:700">المدير: د. أيمن العفيفي</div>
                <input type="file" id="directorSignatureInput" accept="image/*" style="display:none">
                <div style="display:flex;gap:6px;margin-top:6px"><button class="btn btn-outline btn-sm" id="uploadDirSigBtn">رفع</button><button class="btn btn-light btn-sm" id="clearDirSigBtn">مسح</button></div>
              </div>

              <div style="min-width:220px">
                <div class="signature-preview" id="supervisorSignaturePreview"><div class="upload-placeholder"><i class="fas fa-signature"></i><div>توقيع المشرف</div></div></div>
                <div style="text-align:center;font-weight:700">المشرف: د. هشام المهدي</div>
                <input type="file" id="supervisorSignatureInput" accept="image/*" style="display:none">
                <div style="display:flex;gap:6px;margin-top:6px"><button class="btn btn-outline btn-sm" id="uploadSupSigBtn">رفع</button><button class="btn btn-light btn-sm" id="clearSupSigBtn">مسح</button></div>
              </div>
            </div>
          </div>

          <!-- إضافة قسم إدارة الشعار -->
          <div class="form-group">
            <label class="form-label">إدارة الشعار</label>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <button class="btn btn-outline" id="uploadLogoToGithubBtn">
                <i class="fas fa-cloud-upload-alt"></i> رفع الشعار إلى GitHub
              </button>
              <button class="btn btn-light" id="syncLogoFromGithubBtn">
                <i class="fas fa-cloud-download-alt"></i> تحميل الشعار من GitHub
              </button>
            </div>
            <small style="color:#6b7b8a">مسار الشعار في GitHub: assets/logo.png</small>
          </div>

          <div class="form-group"><label class="form-label">طريقة الحفظ</label>
            <div style="display:flex;gap:12px;flex-direction:column;max-width:400px">
              <label><input type="radio" name="saveMode" value="local" id="saveLocal"> 💾 حفظ محلي فقط</label>
              <label><input type="radio" name="saveMode" value="github" id="saveGithub"> ☁️ رفع إلى GitHub فقط</label>
              <label><input type="radio" name="saveMode" value="both" id="saveBoth"> 🔄 محلي + GitHub</label>
              <small id="saveModeHint" style="color:#6b7b8a;margin-top:6px"></small>
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">GitHub Token</label>
            <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
              <input id="githubTokenInput" class="form-control" placeholder="أدخل توكن GitHub هنا (ghp_...)">
              <button class="btn btn-outline" id="saveGithubTokenBtn"><i class="fas fa-save"></i> حفظ التوكن</button>
              <button class="btn btn-light" id="clearGithubTokenBtn"><i class="fas fa-trash"></i> مسح التوكن</button>
            </div>
            <small style="color:#6b7b8a">سيحفظ التوكن في متصفحك (Local Storage) لتجربة سهلة على الموبايل.</small>
          </div>

          <div class="form-group" style="display:flex;gap:8px;align-items:center">
            <button class="btn btn-outline" id="testGithubBtn"><i class="fas fa-link"></i> اختبار الاتصال بـ GitHub</button>
            <div id="testGithubStatus" style="font-weight:700;color:#6b7b8a"></div>
          </div>

          <!-- قسم تصحيح الأخطاء للموبايل -->
          <div class="form-group">
            <label class="form-label">تصحيح الأخطاء</label>
            <div style="display:flex;gap:8px;flex-wrap:wrap;flex-direction:column;">
              <button class="btn btn-outline" id="mobileTestToken">
                <i class="fas fa-key"></i> اختبار التوكن
              </button>
              <button class="btn btn-outline" id="mobileTestUpload">
                <i class="fas fa-upload"></i> اختبار الرفع
              </button>
              <button class="btn btn-outline" id="mobileShowToken">
                <i class="fas fa-eye"></i> عرض التوكن
              </button>
              <button class="btn btn-outline" id="mobileCheckRepo">
                <i class="fas fa-folder"></i> التحقق من المستودع
              </button>
            </div>
          </div>

          <div class="form-group"><button class="btn btn-warning" id="btnAddSample">إضافة بيانات تجريبية</button><button class="btn btn-danger" id="btnClearData">مسح جميع البيانات</button></div>
        </div></div>
      </section>
    </main>

    <footer class="app-footer" role="navigation" aria-label="تذييل">
      <button class="footer-btn active" data-page="inventory"><i class="fas fa-boxes"></i><span>المخزون</span></button>
      <button class="footer-btn" data-page="add"><i class="fas fa-plus-circle"></i><span>إضافة</span></button>
      <button class="footer-btn" data-page="reports"><i class="fas fa-chart-bar"></i><span>التقارير</span></button>
      <button class="footer-btn" data-page="settings"><i class="fas fa-cog"></i><span>الإعدادات</span></button>
    </footer>
  </div>

  <div id="notification" class="notification" role="alert" aria-live="assertive"><span id="notificationMessage"></span><button onclick="hideNotification()" style="background:none;border:none;color:#fff;font-size:16px"><i class="fas fa-times"></i></button></div>
  <div id="loadingOverlay" class="loading-overlay"><div style="text-align:center"><div class="loading-spinner" style="width:48px;height:48px;border:5px solid rgba(255,255,255,0.2);border-top-color:#fff;border-radius:50%;animation:spin 1s linear infinite"></div><div style="margin-top:12px">جاري المعالجة...</div></div></div>

  <script>
    // الكود الكامل مع استبدال مكتبات PDF
    let db = null, SQL = null; let currentInventory = []; let currentPage = 1; const itemsPerPage = 10;

    document.addEventListener('DOMContentLoaded', async ()=>{
      wireNavigation();
      await initSQL();
      bindUI();
      loadTheme();
      loadSignatures();
      
      // محاولة تحميل الشعار من GitHub إذا لم يكن موجودًا محليًا
      if(!localStorage.getItem('labLogo') && window._inventorySessionToken){
        showLoading(true);
        const logo = await loadLogoFromGitHub();
        if(logo){
          localStorage.setItem('labLogo', logo);
          notify('✅ تم تحميل الشعار من GitHub تلقائيًا','success');
        }
        showLoading(false);
      }
      
      renderHeaderLogoFromStorage();
      loadInventory();
      applySaveModeToUI();
    });

    // ================= إدارة الشعار مع GitHub =================
    // دالة لرفع الشعار إلى GitHub
    async function uploadLogoToGitHub() {
      try {
        const logoBase64 = localStorage.getItem('labLogo');
        if (!logoBase64) {
          console.log('No logo found in localStorage');
          notify('❌ لا يوجد شعار محفوظ محليًا','error');
          return false;
        }

        // تحويل base64 إلى blob
        const response = await fetch(logoBase64);
        const blob = await response.blob();

        const pathInRepo = 'assets/logo.png';
        const message = 'رفع شعار المختبر من نظام الجرد';

        const success = await uploadToGitHub(blob, pathInRepo, message);
        
        if (success) {
          console.log('✅ تم رفع الشعار إلى GitHub بنجاح');
          return true;
        } else {
          console.log('❌ فشل رفع الشعار إلى GitHub');
          return false;
        }
      } catch (error) {
        console.error('🚨 خطأ في رفع الشعار:', error);
        return false;
      }
    }

    // دالة لتحميل الشعار من GitHub
    async function loadLogoFromGitHub() {
      try {
        if (!window._inventorySessionToken) return null;
        
        const url = `https://api.github.com/repos/${window._inventoryGithubOwner}/${window._inventoryGithubRepo}/contents/assets/logo.png`;
        
        const response = await fetch(url, {
          headers: {
            'Authorization': 'Bearer ' + window._inventorySessionToken,
            'Accept': 'application/vnd.github.v3.raw'
          }
        });
        
        if (response.ok) {
          const blob = await response.blob();
          return new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.readAsDataURL(blob);
          });
        }
        return null;
      } catch (error) {
        console.error('Error loading logo from GitHub:', error);
        return null;
      }
    }

    // Navigation wiring
    function wireNavigation(){
      const btns = document.querySelectorAll('.nav-item, .footer-btn');
      btns.forEach(b=> b.addEventListener('click', ()=>{
        const page = b.getAttribute('data-page');
        showPage(page);
        document.querySelectorAll('.nav-item, .footer-btn').forEach(x=> x.classList.toggle('active', x.getAttribute('data-page')===page));
      }));
      document.getElementById('btnAdd')?.addEventListener('click', ()=> showPage('add'));
      document.getElementById('backToInventory')?.addEventListener('click', ()=> showPage('inventory'));
    }

    function showPage(page){
      document.querySelectorAll('.page').forEach(p=> p.classList.remove('active'));
      const el = document.getElementById(page);
      if(el) el.classList.add('active');
      document.querySelectorAll('.nav-item, .footer-btn').forEach(x=> x.classList.toggle('active', x.getAttribute('data-page')===page));
      if(page==='inventory') document.getElementById('searchInput')?.focus();
    }

    // SQL init + storage
    async function initSQL(){
      showLoading(true);
      try{
        SQL = await initSqlJs({ locateFile: f=>`https://cdn.jsdelivr.net/npm/sql.js@1.8.0/dist/${f}` });
        const saved = localStorage.getItem('inventoryDatabase');
        if(saved){
          const arr = Uint8Array.from(atob(saved), c=>c.charCodeAt(0));
          db = new SQL.Database(arr);
        } else {
          db = new SQL.Database();
          createTables();
        }
        notify('تم تهيئة قاعدة البيانات','success');
      }catch(e){ console.error(e); notify('خطأ في تهيئة SQL','error'); }
      finally{ showLoading(false); }
    }

    function createTables(){
      try{
        db.run(`CREATE TABLE IF NOT EXISTS inventory (
          id INTEGER PRIMARY KEY AUTOINCREMENT,
          type TEXT NOT NULL, name TEXT NOT NULL, quantity INTEGER NOT NULL, unit TEXT NOT NULL,
          expiry TEXT, company TEXT, batch TEXT, product TEXT, notes TEXT, image TEXT,
          created_at DATETIME DEFAULT CURRENT_TIMESTAMP, updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
        )`);
        saveDatabaseToStorage();
      }catch(e){ console.error(e); }
    }

    function saveDatabaseToStorage(){
      try{
        const data = db.export();
        const bin = String.fromCharCode(...data);
        localStorage.setItem('inventoryDatabase', btoa(bin));
      }catch(e){ console.error(e); }
    }

    // UI bindings
    function bindUI(){
      document.getElementById('searchInput')?.addEventListener('input', ()=>{ currentPage=1; loadInventory(); });
      document.getElementById('itemName')?.addEventListener('change', function(){ 
        const custom = document.getElementById('customItemName'); 
        if(this.value==='أخرى'){ custom.style.display='block'; custom.required=true; } 
        else { custom.style.display='none'; custom.required=false; } 
      });
      document.getElementById('imageInput')?.addEventListener('change', e=> handleImageUpload(e,'imagePreview'));
      document.getElementById('pickImageBtn')?.addEventListener('click', ()=> document.getElementById('imageInput').click());
      document.getElementById('addItemForm')?.addEventListener('submit', e=>{ e.preventDefault(); saveItem(); });
      document.getElementById('resetFormBtn')?.addEventListener('click', ()=> resetForm());
      document.getElementById('btnExcel')?.addEventListener('click', ()=> exportToExcel());
      document.getElementById('btnPDF')?.addEventListener('click', ()=> exportToPDF());
      document.getElementById('btnPrint')?.addEventListener('click', ()=> printTable());
      document.getElementById('btnExportDB')?.addEventListener('click', ()=> exportDatabase());
      document.getElementById('exportDbBtn')?.addEventListener('click', ()=> exportDatabase());
      document.getElementById('importDbBtn')?.addEventListener('click', ()=> document.getElementById('importDatabaseInput').click());
      document.getElementById('importDatabaseInput')?.addEventListener('change', e=> importDatabaseFile(e));
      document.getElementById('uploadDirSigBtn')?.addEventListener('click', ()=> document.getElementById('directorSignatureInput').click());
      document.getElementById('uploadSupSigBtn')?.addEventListener('click', ()=> document.getElementById('supervisorSignatureInput').click());
      document.getElementById('directorSignatureInput')?.addEventListener('change', e=> handleSignatureUpload(e,'director'));
      document.getElementById('supervisorSignatureInput')?.addEventListener('change', e=> handleSignatureUpload(e,'supervisor'));
      document.getElementById('clearDirSigBtn')?.addEventListener('click', ()=> clearSignature('director'));
      document.getElementById('clearSupSigBtn')?.addEventListener('click', ()=> clearSignature('supervisor'));
      document.getElementById('btnAddSample')?.addEventListener('click', ()=> addSampleData());
      document.getElementById('btnClearData')?.addEventListener('click', ()=> clearData());
      document.getElementById('toggleThemeBtn')?.addEventListener('click', ()=> toggleTheme());
      document.getElementById('changeLogoBtn')?.addEventListener('click', ()=> changeLogo());
      document.getElementById('closeAppBtn')?.addEventListener('click', ()=> closeApplication());
      
      // GitHub settings
      document.getElementById('saveLocal')?.addEventListener('change', ()=> setSaveMode('local'));
      document.getElementById('saveGithub')?.addEventListener('change', ()=> setSaveMode('github'));
      document.getElementById('saveBoth')?.addEventListener('change', ()=> setSaveMode('both'));
      document.getElementById('testGithubBtn')?.addEventListener('click', ()=> testGithubConnection());
      document.getElementById('saveGithubTokenBtn')?.addEventListener('click', function(){
        const v = document.getElementById('githubTokenInput').value.trim();
        if(!v){ notify('التوكن فارغ','warning'); return; }
        localStorage.setItem('inventory_github_token', v);
        window._inventorySessionToken = v;
        notify('تم حفظ التوكن محليًا','success');
      });
      document.getElementById('clearGithubTokenBtn')?.addEventListener('click', function(){
        localStorage.removeItem('inventory_github_token');
        window._inventorySessionToken = null;
        if(document.getElementById('githubTokenInput')) document.getElementById('githubTokenInput').value = '';
        notify('تم مسح التوكن','success');
      });

      // إدارة الشعار مع GitHub
      document.getElementById('uploadLogoToGithubBtn')?.addEventListener('click', async ()=>{
        if (!localStorage.getItem('labLogo')) {
          notify('❌ لا يوجد شعار محفوظ محليًا','error');
          return;
        }
        showLoading(true);
        const success = await uploadLogoToGitHub();
        showLoading(false);
        if(success){
          notify('✅ تم رفع الشعار إلى GitHub بنجاح','success');
        } else {
          notify('❌ فشل رفع الشعار إلى GitHub','error');
        }
      });

      document.getElementById('syncLogoFromGithubBtn')?.addEventListener('click', async ()=>{
        showLoading(true);
        const logo = await loadLogoFromGitHub();
        showLoading(false);
        if(logo){
          localStorage.setItem('labLogo', logo);
          renderHeaderLogoFromStorage();
          notify('✅ تم تحميل الشعار من GitHub','success');
        } else {
          notify('❌ فشل تحميل الشعار من GitHub','error');
        }
      });

      // أزرار تصحيح الأخطاء للموبايل
      document.getElementById('mobileTestToken')?.addEventListener('click', async function() {
        showLoading(true);
        const result = await testToken();
        showLoading(false);
        
        if (result) {
          notify('✅ التوكن صالح', 'success');
        } else {
          notify('❌ التوكن غير صالح', 'error');
        }
      });

      document.getElementById('mobileTestUpload')?.addEventListener('click', async function() {
        showLoading(true);
        
        try {
          const testContent = 'اختبار رفع من الموبايل - ' + new Date().toLocaleString('ar-EG');
          const testBlob = new Blob([testContent], {type: 'text/plain'});
          const path = 'mobile-test-' + Date.now() + '.txt';
          
          const success = await uploadToGitHub(testBlob, path, 'اختبار من الموبايل');
          
          if (success) {
            notify('✅ ✅ تم اختبار الرفع بنجاح!', 'success');
          } else {
            notify('❌ فشل اختبار الرفع', 'error');
          }
        } catch (error) {
          notify('🚨 خطأ: ' + error.message, 'error');
        } finally {
          showLoading(false);
        }
      });

      document.getElementById('mobileShowToken')?.addEventListener('click', function() {
        const token = localStorage.getItem('inventory_github_token');
        if (token) {
          // إظهار أول 10 أحرف فقط للأمان
          alert('🔑 التوكن: ' + token.substring(0,10) + '...\n\n✅ التوكن موجود ومخزن');
        } else {
          alert('❌ لا يوجد توكن مخزن');
        }
      });

      document.getElementById('mobileCheckRepo')?.addEventListener('click', async function() {
        showLoading(true);
        
        try {
          const token = localStorage.getItem('inventory_github_token');
          if (!token) {
            notify('❌ لا يوجد توكن', 'error');
            return;
          }
          
          const response = await fetch('https://api.github.com/repos/afifiayman/inventory-lab-system', {
            headers: {
              'Authorization': 'Bearer ' + token,
              'Accept': 'application/vnd.github.v3+json'
            }
          });
          
          if (response.ok) {
            const repo = await response.json();
            notify(`✅ المستودع: ${repo.full_name}\n⭐ النجوم: ${repo.stargazers_count}\n🔓 ${repo.private ? 'خاص' : 'عام'}`, 'success');
          } else {
            notify(`❌ خطأ: ${response.status}`, 'error');
          }
        } catch (error) {
          notify('🚨 خطأ في الاتصال', 'error');
        } finally {
          showLoading(false);
        }
      });

      document.querySelectorAll('.footer-btn').forEach(b=> b.setAttribute('tabindex', '0'));
    }

    // دالة اختبار التوكن
    async function testToken() {
        const token = localStorage.getItem('inventory_github_token');
        if (!token) {
            console.error('❌ لا يوجد توكن');
            notify('❌ لم يتم إدخال التوكن', 'error');
            return false;
        }
        
        console.log('🔑 التوكن:', token.substring(0, 10) + '...');
        
        try {
            const response = await fetch('https://api.github.com/user', {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Accept': 'application/vnd.github.v3+json'
                }
            });
            
            if (response.ok) {
                const userData = await response.json();
                console.log('✅ التوكن صالح - المستخدم:', userData.login);
                return true;
            } else {
                console.error('❌ التوكن غير صالح - Status:', response.status);
                const error = await response.text();
                console.error('تفاصيل الخطأ:', error);
                return false;
            }
        } catch (error) {
            console.error('🚨 خطأ في الاتصال:', error);
            return false;
        }
    }

    // Inventory functions
    function loadInventory(){
      try{
        const term = document.getElementById('searchInput')?.value.trim().toLowerCase() || '';
        let query = 'SELECT * FROM inventory';
        let params = [];
        if(term){ query += ' WHERE name LIKE ? OR type LIKE ? OR company LIKE ?'; params = [`%${term}%`,`%${term}%`,`%${term}%`]; }
        query += ' ORDER BY created_at DESC';
        const res = db.exec(query, params);
        if(res.length>0){
          currentInventory = res[0].values.map(row=>{ const obj={}; res[0].columns.forEach((c,i)=> obj[c]=row[i]); return obj; });
        } else currentInventory = [];
        displayInventoryTable(currentInventory);
        updateStats(currentInventory);
      }catch(e){ console.error(e); notify('خطأ في تحميل المخزون','error'); }
    }

    function displayInventoryTable(data){
      const tbody = document.getElementById('inventoryBody'); if(!tbody) return; tbody.innerHTML='';
      if(data.length===0){ tbody.innerHTML = `<tr><td colspan="8" style="text-align:center;padding:20px;"><i class="fas fa-box-open" style="font-size:36px;color:#7f8c8d"></i><div>لا توجد بيانات في المخزون</div></td></tr>`; document.getElementById('pagination').innerHTML=''; return; }
      const totalPages = Math.ceil(data.length/itemsPerPage);
      const start = (currentPage-1)*itemsPerPage;
      const pageData = data.slice(start, start+itemsPerPage);
      pageData.forEach((it, idx)=>{
        const i = start + idx + 1;
        const expired = checkIfExpired(it.expiry);
        const row = document.createElement('tr'); if(expired) row.classList.add('expired'); else if(parseInt(it.quantity||0)<10) row.classList.add('low-stock');
        row.innerHTML = `<td>${i}</td>
  <td>${it.image?`<img src="${it.image}" class="table-img" style="width:80px;height:60px;object-fit:cover;border-radius:8px">`:'<div style="width:80px;height:60px;background:#f8f8f8;border-radius:8px;display:flex;align-items:center;justify-content:center"><i class="fas fa-image" style="color:#7f8c8d;font-size:20px"></i></div>'}</td>

          <td>${it.type}</td><td>${it.name}</td><td>${it.quantity}</td><td>${it.unit}</td><td>${formatExpiryDate(it.expiry)}</td>
          <td><div style="display:flex;gap:6px;justify-content:center"><button class="btn btn-light" onclick="editItem(${it.id})"><i class="fas fa-edit"></i></button><button class="btn btn-danger" onclick="deleteItem(${it.id})"><i class="fas fa-trash"></i></button></div></td>`;
        tbody.appendChild(row);
      });
      createPagination(totalPages);
    }

    function createPagination(totalPages){
      const div = document.getElementById('pagination'); div.innerHTML='';
      if(totalPages<=1) return;
      const prev = document.createElement('button'); prev.className='page-btn'; prev.innerHTML='<i class="fas fa-chevron-right"></i>'; prev.disabled = currentPage===1; prev.addEventListener('click', ()=>{ if(currentPage>1){ currentPage--; loadInventory(); } }); div.appendChild(prev);
      for(let i=1;i<=totalPages;i++){ const b=document.createElement('button'); b.className=`page-btn ${i===currentPage?'active':''}`; b.textContent=i; b.addEventListener('click', ()=>{ currentPage=i; loadInventory(); }); div.appendChild(b); }
      const next = document.createElement('button'); next.className='page-btn'; next.innerHTML='<i class="fas fa-chevron-left"></i>'; next.disabled = currentPage===totalPages; next.addEventListener('click', ()=>{ if(currentPage<totalPages){ currentPage++; loadInventory(); } }); div.appendChild(next);
    }

    function checkIfExpired(expiry){ if(!expiry) return false; const [y,m]=expiry.split('-').map(Number); const now=new Date(); const cy=now.getFullYear(), cm=now.getMonth()+1; return y<cy || (y===cy && m<cm); }
    function formatExpiryDate(expiry){ if(!expiry) return '-'; const [y,m]=expiry.split('-'); const months=['يناير','فبراير','مارس','أبريل','مايو','يونيو','يوليو','أغسطس','سبتمبر','أكتوبر','نوفمبر','ديسمبر']; return `${months[parseInt(m)-1]} ${y}`; }

    function updateStats(data){
      const total = data.length;
      const expired = data.filter(i=> checkIfExpired(i.expiry)).length;
      const low = data.filter(i=> parseInt(i.quantity||0) < 10).length;
      const totQty = data.reduce((s,i)=> s + parseInt(i.quantity||0||0), 0);
      document.getElementById('totalItems').textContent = total; document.getElementById('expiredItems').textContent = expired;
      document.getElementById('lowStockItems').textContent = low; document.getElementById('totalQuantity').textContent = totQty;
      if(document.getElementById('reportTotal')) document.getElementById('reportTotal').textContent = total;
      if(document.getElementById('reportExpired')) document.getElementById('reportExpired').textContent = expired;
      if(document.getElementById('reportLowStock')) document.getElementById('reportLowStock').textContent = low;
      if(document.getElementById('reportTypes')) document.getElementById('reportTypes').textContent = new Set(data.map(d=>d.type)).size;
    }

    // CRUD functions
    function saveItem(){
      try{
        const id = document.getElementById('editItemId').value;
        let name = document.getElementById('itemName').value;
        if(name === 'أخرى') name = document.getElementById('customItemName').value;
        const data = {
          type: document.getElementById('itemType').value,
          name: name,
          quantity: parseInt(document.getElementById('itemQuantity').value||0),
          unit: document.getElementById('itemUnit').value,
          expiry: document.getElementById('itemExpiry').value,
          company: document.getElementById('itemCompany').value,
          batch: document.getElementById('itemBatch').value,
          product: document.getElementById('itemProduct').value,
          notes: document.getElementById('itemNotes').value,
          image: document.getElementById('imagePreview').querySelector('img')?.src || ''
        };
        if(!data.type || !data.name || isNaN(data.quantity) || !data.unit || !data.expiry){ notify('يرجى ملء الحقول المطلوبة','error'); return; }
        if(id){
          db.run('UPDATE inventory SET type=?, name=?, quantity=?, unit=?, expiry=?, company=?, batch=?, product=?, notes=?, image=?, updated_at=CURRENT_TIMESTAMP WHERE id=?',
            [data.type,data.name,data.quantity,data.unit,data.expiry,data.company,data.batch,data.product,data.notes,data.image,id]);
          notify('تم تحديث الصنف','success');
        } else {
          db.run('INSERT INTO inventory (type,name,quantity,unit,expiry,company,batch,product,notes,image) VALUES (?,?,?,?,?,?,?,?,?,?)',
            [data.type,data.name,data.quantity,data.unit,data.expiry,data.company,data.batch,data.product,data.notes,data.image]);
          notify('تم إضافة الصنف','success');
        }
        saveDatabaseToStorage();
        resetForm();
        showPage('inventory');
        loadInventory();
      }catch(e){ console.error(e); notify('خطأ في حفظ الصنف','error'); }
    }

    function editItem(id){
      try{
        const res = db.exec('SELECT * FROM inventory WHERE id=?', [id]);
        if(res.length>0){
          const itRow = res[0].values[0]; const cols=res[0].columns; const it={}; cols.forEach((c,i)=> it[c]=itRow[i]);
          document.getElementById('editItemId').value = it.id;
          document.getElementById('itemType').value = it.type;
          const known=['Rift valley competition elisa','FMD NSP competition elisa','Bluetongue competition elisa','PPR competition elisa','RBT rose bengal antigen','لقاح الحمى القلاعية','لقاح الجدري','مصل البروسيلا','مستنبت الخلايا'];
          if(known.includes(it.name)){ document.getElementById('itemName').value = it.name; document.getElementById('customItemName').style.display='none'; } else { document.getElementById('itemName').value='أخرى'; document.getElementById('customItemName').value=it.name; document.getElementById('customItemName').style.display='block'; }
        document.getElementById('itemQuantity').value = it.quantity;
        document.getElementById('itemUnit').value = it.unit;
        document.getElementById('itemExpiry').value = it.expiry;
        document.getElementById('itemCompany').value = it.company||'';
        document.getElementById('itemBatch').value = it.batch||'';
        document.getElementById('itemProduct').value = it.product||'';
        document.getElementById('itemNotes').value = it.notes||'';
        const prev = document.getElementById('imagePreview'); prev.innerHTML=''; if(it.image){ const img=document.createElement('img'); img.src=it.image; prev.appendChild(img); } else prev.innerHTML='<div class="upload-placeholder"><i class="fas fa-image"></i><div>انقر لرفع صورة</div></div>';
        document.getElementById('formTitle').textContent = 'تعديل الصنف';
        showPage('add');
        }
      }catch(e){ console.error(e); notify('خطأ في تحميل الصنف','error'); }
    }

    function deleteItem(id){
      if(confirm('هل أنت متأكد من حذف هذا الصنف؟')){
        try{
          db.run('DELETE FROM inventory WHERE id=?', [id]);
          saveDatabaseToStorage();
          notify('تم حذف الصنف','success');
          loadInventory();
        }catch(e){ console.error(e); notify('خطأ في الحذف','error'); }
      }
    }

    function resetForm(){
      document.getElementById('addItemForm')?.reset();
      document.getElementById('editItemId').value='';
      document.getElementById('customItemName').style.display='none';
      document.getElementById('imagePreview').innerHTML = '<div class="upload-placeholder"><i class="fas fa-image"></i><div>انقر لرفع صورة</div></div>';
      document.getElementById('formTitle').textContent='إضافة صنف جديد';
    }

    // Image handling
    function handleImageUpload(e, previewId){
      const file = e.target.files[0]; if(!file) return;
      if(!file.type.match('image.*')){ notify('الملف يجب أن يكون صورة','error'); return; }
      if(file.size>2*1024*1024){ notify('حجم الصورة أكبر من 2MB','error'); return; }
      const reader = new FileReader();
      reader.onload = function(ev){
        const preview = document.getElementById(previewId); preview.innerHTML=''; const img=document.createElement('img'); img.src = ev.target.result; preview.appendChild(img);
      };
      reader.readAsDataURL(file);
    }

    // Signatures & logo
    function handleSignatureUpload(e,type){
      const file = e.target.files[0]; if(!file) return;
      if(!file.type.match('image.*')){ notify('الملف يجب أن يكون صورة','error'); return; }
      if(file.size>2*1024*1024){ notify('حجم الصورة أكبر من 2MB','error'); return; }
      const reader = new FileReader();
      reader.onload = function(ev){ localStorage.setItem(type+'Signature', ev.target.result); loadSignatures(); notify('تم حفظ التوقيع','success'); };
      reader.readAsDataURL(file);
    }
    function loadSignatures(){
      const dir = localStorage.getItem('directorSignature'); const sup = localStorage.getItem('supervisorSignature');
      const dPrev = document.getElementById('directorSignaturePreview'); const sPrev = document.getElementById('supervisorSignaturePreview');
      if(dPrev){ dPrev.innerHTML = dir? `<img src="${dir}" style="max-width:100%;max-height:100%;object-fit:contain">` : '<div class="upload-placeholder"><i class="fas fa-signature"></i><div>توقيع المدير</div></div>'; }
      if(sPrev){ sPrev.innerHTML = sup? `<img src="${sup}" style="max-width:100%;max-height:100%;object-fit:contain">` : '<div class="upload-placeholder"><i class="fas fa-signature"></i><div>توقيع المشرف</div></div>'; }
    }
    function clearSignature(type){ localStorage.removeItem(type+'Signature'); loadSignatures(); notify('تم مسح التوقيع','success'); }

    function changeLogo(){
      const input = document.createElement('input'); input.type='file'; input.accept='image/*';
      input.onchange = async function(e){
        const f = e.target.files[0]; if(!f) return;
        if(!f.type.match('image.*')){ notify('الملف يجب أن يكون صورة','error'); return; }
        if(f.size>2*1024*1024){ notify('حجم الصورة أكبر من 2MB','error'); return; }
        const r = new FileReader(); r.onload = async function(ev){
          // حفظ الشعار محليًا
          localStorage.setItem('labLogo', ev.target.result); 
          renderHeaderLogoFromStorage(); 
          
          // رفع الشعار إلى GitHub إذا كان الوضع مناسبًا
          const mode = getSaveMode();
          if (mode !== 'local' && window._inventorySessionToken) {
            showLoading(true);
            const uploadSuccess = await uploadLogoToGitHub();
            showLoading(false);
            
            if (uploadSuccess) {
              notify('✅ تم تغيير الشعار ورفعه إلى GitHub','success');
            } else {
              notify('⚠️ تم تغيير الشعار محليًا ولكن فشل الرفع إلى GitHub','warning');
            }
          } else {
            notify('تم تغيير الشعار محليًا','success');
          }
        }; 
        r.readAsDataURL(f);
      };
      input.click();
    }

    function renderHeaderLogoFromStorage(){
      const logo = localStorage.getItem('labLogo');
      const el = document.getElementById('labLogoImg');
      if(el){ if(logo){ el.src = logo; el.style.display='block'; } }
    }

    // Export DB
    function exportDatabase(){
      try{
        const data = db.export();
        const blob = new Blob([data], { type: 'application/octet-stream' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = `inventory_db_${todayDateString()}.sqlite`; document.body.appendChild(a); a.click(); document.body.removeChild(a);
        notify('تم تنزيل نسخة من قاعدة البيانات','success');
      }catch(e){ console.error(e); notify('خطأ في تصدير قاعدة البيانات','error'); }
    }
    function importDatabaseFile(e){
      const file = e.target.files[0]; if(!file) return;
      const reader = new FileReader();
      reader.onload = function(ev){
        try{ const u8 = new Uint8Array(ev.target.result); db = new SQL.Database(u8); saveDatabaseToStorage(); loadInventory(); notify('تم استيراد قاعدة البيانات','success'); }catch(err){ console.error(err); notify('خطأ في استيراد الملف','error'); }
      };
      reader.readAsArrayBuffer(file);
    }

    // Close application function
    function closeApplication(){
      if(confirm('هل تريد إغلاق التطبيق؟ سيتم حفظ جميع بياناتك تلقائياً.')){
        saveDatabaseToStorage();
        notify('جاري إغلاق التطبيق...', 'success');
        setTimeout(() => {
          document.body.innerHTML = `
            <div style="display: flex; justify-content: center; align-items: center; height: 100vh; background: var(--bg); flex-direction: column; gap: 20px;">
              <div style="font-size: 24px; color: var(--primary); font-weight: bold;">
                تم إغلاق التطبيق بنجاح
              </div>
              <div style="color: var(--text);">
                يمكنك إغلاق هذه النافذة الآن
              </div>
              <button onclick="location.reload()" class="btn btn-primary" style="margin-top: 20px;">
                <i class="fas fa-redo"></i> إعادة فتح التطبيق
              </button>
            </div>
          `;
        }, 1500);
      }
    }

    /* ================= تصدير PDF باستخدام html2pdf.js ================= */
  async function exportToPDF() {
  try {
    showLoading(true);
    
    // إنشاء عنصر PDF
    const exportElement = document.createElement('div');
    exportElement.className = 'pdf-export';
    
    let logo = localStorage.getItem('labLogo');
    // إذا لم يوجد الشعار محليًا، جربه من GitHub
    if (!logo && window._inventorySessionToken) {
      logo = await loadLogoFromGitHub();
    }
    const directorSig = localStorage.getItem('directorSignature');
    const supervisorSig = localStorage.getItem('supervisorSignature');
    const dateStr = new Date().toLocaleDateString('ar-EG');
    
    exportElement.innerHTML = `
      <div class="pdf-header">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
          <div style="text-align: right; flex: 1;">
            <div style="font-size: 14px; font-weight: bold; margin-bottom: 5px;">الشركة الدولية الاولى</div>
            <div style="font-size: 12px;">المحجر الصحي الوطني بربرة</div>
          </div>
          
          <div style="flex: 1; text-align: center;">
            ${logo ? `<img src="${logo}" style="max-width: 100px; max-height: 50px; margin: 0 auto;">` : ''}
          </div>
          
          <div style="text-align: left; flex: 1;">
            <div style="font-size: 14px; font-weight: bold; margin-bottom: 5px;">PRIMA INTERNATIONAL COMPANY</div>
            <div style="font-size: 12px;">BERBERA NATIONAL ANIMAL QUARANTINE</div>
          </div>
        </div>
        
        <h1 style="color: #2b7bd3; margin: 10px 0 5px 0;">نظام جرد المختبر</h1>
        <h2 style="margin: 5px 0 10px 0;">جرد مشخصات ولقاحات المختبر</h2>
        <div style="font-size: 14px; color: #666;">تاريخ الجرد: ${dateStr}</div>
      </div>
      
      <table class="pdf-table">
        <thead>
          <tr>
            <th style="width: 3%;">م</th>
            <th style="width: 7%;">الصورة</th>
            <th style="width: 8%;">النوع</th>
            <th style="width: 15%;">الاسم</th>
            <th style="width: 5%;">الكمية</th>
            <th style="width: 6%;">الوحدة</th>
            <th style="width: 8%;">تاريخ الانتهاء</th>
            <th style="width: 10%;">الشركة</th>
            <th style="width: 8%;">رقم التشغيلة</th>
            <th style="width: 10%;">رقم المنتج</th>
            <th style="width: 20%;">الملاحظات</th>
          </tr>
        </thead>
        <tbody>
          ${currentInventory.map((item, index) => `
            <tr style="${checkIfExpired(item.expiry) ? 'background-color: #ffebee;' : parseInt(item.quantity) < 10 ? 'background-color: #fff3e0;' : ''}">
              <td>${index + 1}</td>
              <td>${item.image ? `<img src="${item.image}" style="max-width: 50px; max-height: 40px; object-fit: cover; border-radius: 3px;">` : '---'}</td>
              <td>${item.type}</td>
              <td style="text-align: right;">${item.name}</td>
              <td>${item.quantity}</td>
              <td>${item.unit}</td>
              <td style="${checkIfExpired(item.expiry) ? 'color: #e74c3c; font-weight: bold;' : ''}">${formatExpiryDate(item.expiry)}</td>
              <td>${item.company || '-'}</td>
              <td>${item.batch || '-'}</td>
              <td>${item.product || '-'}</td>
              <td style="text-align: right; font-size: 11px;">${item.notes || '-'}</td>
            </tr>
          `).join('')}
        </tbody>
      </table>
      
      <div class="pdf-signatures">
        <div style="text-align: right; flex: 1;">
          ${directorSig ? `<img src="${directorSig}" style="max-width: 120px; max-height: 50px; display: block; margin: 0 auto 5px;">` : '<div style="height: 50px;"></div>'}
          <div style="border-top: 1px solid #333; padding-top: 5px; font-weight: bold;">توقيع مشرف المختبر</div>
          <div>د. هشام المهدي</div>
        </div>
        
        <div style="text-align: left; flex: 1;">
          ${supervisorSig ? `<img src="${supervisorSig}" style="max-width: 120px; max-height: 50px; display: block; margin: 0 auto 5px;">` : '<div style="height: 50px;"></div>'}
          <div style="border-top: 1px solid #333; padding-top: 5px; font-weight: bold;">توقيع مدير المختبر</div>
          <div>د. ايمن العفيفي</div>
        </div>
      </div>
      
      <div class="pdf-footer">
        تم إنشاء هذا التقرير بواسطة نظام جرد المختبر - Inventory Advance 2025
      </div>
    `;

    document.body.appendChild(exportElement);

    const options = {
      margin: 10,
      filename: `جرد_المختبر_${new Date().toISOString().slice(0,10)}.pdf`,
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: { 
        scale: 2,
        useCORS: true,
        logging: false
      },
      jsPDF: { 
        unit: 'mm', 
        format: 'a4', 
        orientation: 'landscape' 
      }
    };

    // ⭐ الكود المصحح - إنشاء blob أولاً
    const pdf = html2pdf().set(options).from(exportElement);
    const pdfBlob = await pdf.output('blob'); // ✅ استخدام output بدل outputPdf
    
    // حفظ محلي باستخدام blob
    const url = URL.createObjectURL(pdfBlob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `جرد_المختبر_${new Date().toISOString().slice(0,10)}.pdf`;
    link.click();
    URL.revokeObjectURL(url); // تحرير الذاكرة
    
    document.body.removeChild(exportElement);

    // ⭐ رفع إلى GitHub
    const timestamp = new Date().toISOString().slice(0,16).replace(/[:T]/g,'-');
    const filename = `جرد_المختبر_${timestamp}.pdf`;
    
    const uploadSuccess = await uploadIfAllowed(
      pdfBlob, 
      `exports/${filename}`,
      `تصدير PDF من نظام الجرد - ${new Date().toLocaleDateString('ar-EG')}`
    );
    
    showLoading(false);
    
    if (uploadSuccess) {
      notify('✅ تم تصدير PDF ورفعه إلى GitHub بنجاح', 'success');
    } else {
      notify('💾 تم تصدير PDF محلياً فقط', 'success');
    }

  } catch (error) {
    console.error('خطأ في تصدير PDF:', error);
    showLoading(false);
    notify('حدث خطأ أثناء إنشاء ملف PDF', 'error');
  }
}
            
		/* ================= تصدير Excel بنفس تنسيق PDF ================= */
async function exportToExcel() {
  try {
    showLoading(true);

    const dateStr = new Date().toLocaleDateString('ar-EG');
    const workbook = new ExcelJS.Workbook();
    
    // إعدادات الصفحة بنفس تنسيق PDF + RTL
    const worksheet = workbook.addWorksheet('جرد المختبر', {
      pageSetup: {
        paperSize: 9, // A4
        orientation: 'landscape',
        fitToPage: true,
        fitToWidth: 1,
        fitToHeight: 0,
        margins: {
          left: 0.7, right: 0.7,
          top: 0.7, bottom: 0.7,
          header: 0.3, footer: 0.3
        }
      },
      properties: {
        defaultColWidth: 15,
        defaultRowHeight: 20
      },
      // ⭐ تفعيل اليمين لليسار
      views: [
        { rightToLeft: true }
      ]
    });

    // إعداد الخطوط - نفس تنسيق PDF
    const titleFont = { name: 'Cairo', size: 16, bold: true, color: { argb: 'FF2B7BD3' } };
    const headerFont = { name: 'Cairo', size: 12, bold: true, color: { argb: 'FFFFFFFF' } };
    const normalFont = { name: 'Cairo', size: 10 };
    const smallFont = { name: 'Cairo', size: 9 };

    // === الرأس - نفس تصميم PDF ===
    // الصف 1: الاسم العربي في سطرين - مثل PDF
    worksheet.mergeCells('A1:D1');
    const arabicLine1 = worksheet.getCell('A1');
    arabicLine1.value = 'الشركة الدولية الاولى';
    arabicLine1.font = { name: 'Cairo', size: 11, bold: true };
    arabicLine1.alignment = { horizontal: 'right', vertical: 'bottom' };

    worksheet.mergeCells('A2:D2');
    const arabicLine2 = worksheet.getCell('A2');
    arabicLine2.value = 'المحجر الصحي الوطني بربرة';
    arabicLine2.font = { name: 'Cairo', size: 10 };
    arabicLine2.alignment = { horizontal: 'right', vertical: 'top' };

    // الصف 1: الاسم الإنجليزي في سطرين - مثل PDF
    worksheet.mergeCells('I1:K1');
    const englishLine1 = worksheet.getCell('I1');
    englishLine1.value = 'PRIMA INTERNATIONAL COMPANY';
    englishLine1.font = { name: 'Cairo', size: 11, bold: true };
    englishLine1.alignment = { horizontal: 'left', vertical: 'bottom' };

    worksheet.mergeCells('I2:K2');
    const englishLine2 = worksheet.getCell('I2');
    englishLine2.value = 'BERBERA NATIONAL ANIMAL QUARANTINE';
    englishLine2.font = { name: 'Cairo', size: 10 };
    englishLine2.alignment = { horizontal: 'left', vertical: 'top' };

    // إضافة الشعار بينهما
    let logoBase64 = localStorage.getItem('labLogo');
    // إذا لم يوجد الشعار محليًا، جربه من GitHub
    if (!logoBase64 && window._inventorySessionToken) {
      logoBase64 = await loadLogoFromGitHub();
    }
    
    if (logoBase64) {
      try {
        const imageId = workbook.addImage({
          base64: logoBase64,
          extension: 'png'
        });
        
        // الشعار يغطي الصفين 1 و 2 في العمود G
        worksheet.addImage(imageId, {
          tl: { col: 6, row: 0 },  // العمود G (6)، الصف 1 (0)
          br: { col: 7, row: 2 }   // إلى العمود G (7)، الصف 3 (2)
        });
        
        worksheet.mergeCells('G1:G2');
        
      } catch (e) {
        console.warn('لا يمكن إضافة الشعار إلى Excel:', e);
        worksheet.mergeCells('G1:G2');
        const logoCell = worksheet.getCell('G1');
        logoCell.value = '[شعار الشركة]';
        logoCell.font = { name: 'Cairo', size: 9, color: { argb: 'FF666666' } };
        logoCell.alignment = { horizontal: 'center', vertical: 'middle' };
      }
    } else {
      worksheet.mergeCells('G1:G2');
      const logoCell = worksheet.getCell('G1');
      logoCell.value = 'بدون شعار';
      logoCell.font = { name: 'Cairo', size: 9, color: { argb: 'FF999999' } };
      logoCell.alignment = { horizontal: 'center', vertical: 'middle' };
    }

    // العنوان الرئيسي يبدأ من الصف 4
    worksheet.mergeCells('A4:K4');
    const mainTitle = worksheet.getCell('A4');
    mainTitle.value = 'نظام جرد المختبر';
    mainTitle.font = { name: 'Cairo', size: 16, bold: true, color: { argb: 'FF2B7BD3' } };
    mainTitle.alignment = { horizontal: 'center', vertical: 'middle' };

    // العنوان الفرعي في الصف 5
    worksheet.mergeCells('A5:K5');
    const subTitle = worksheet.getCell('A5');
    subTitle.value = 'جرد مشخصات ولقاحات المختبر';
    subTitle.font = { name: 'Cairo', size: 14, bold: true };
    subTitle.alignment = { horizontal: 'center', vertical: 'middle' };

    // تاريخ الجرد في الصف 6
    worksheet.mergeCells('A6:K6');
    const dateCell = worksheet.getCell('A6');
    dateCell.value = `تاريخ الجرد: ${dateStr}`;
    dateCell.font = { name: 'Cairo', size: 12, bold: true };
    dateCell.alignment = { horizontal: 'center', vertical: 'middle' };

    // صف فارغ قبل الجدول
    worksheet.addRow([]);

    // === رؤوس الأعمدة - نفس تنسيق PDF ===
    const headers = ['م', 'الصورة', 'النوع', 'الاسم', 'الكمية', 'الوحدة', 'تاريخ الانتهاء', 'الشركة', 'رقم التشغيلة', 'رقم المنتج', 'الملاحظات'];
    const headerRow = worksheet.addRow(headers);
    
    // تنسيق رؤوس الأعمدة
    headerRow.eachCell((cell, colNumber) => {
      cell.font = headerFont;
      cell.fill = {
        type: 'pattern',
        pattern: 'solid',
        fgColor: { argb: 'FF2B7BD3' } // نفس لون PDF
      };
      cell.border = {
        top: { style: 'thin', color: { argb: 'FF000000' } },
        left: { style: 'thin', color: { argb: 'FF000000' } },
        bottom: { style: 'thin', color: { argb: 'FF000000' } },
        right: { style: 'thin', color: { argb: 'FF000000' } }
      };
      cell.alignment = { 
        horizontal: 'center', 
        vertical: 'middle',
        wrapText: true
      };
    });

    // === تعبئة البيانات مع الصور ===
    let imageCounter = 0;
    
    for (let index = 0; index < currentInventory.length; index++) {
      const item = currentInventory[index];
      const rowNumber = headerRow.number + 1 + index;
      
      // إضافة الصورة إذا كانت موجودة
      if (item.image && item.image.startsWith('data:image')) {
        try {
          // تحويل base64 إلى buffer
          const base64Data = item.image.split(',')[1];
          const imageBuffer = Uint8Array.from(atob(base64Data), c => c.charCodeAt(0));
          
          // إضافة الصورة إلى المصنف
          const imageId = workbook.addImage({
            buffer: imageBuffer,
            extension: item.image.includes('png') ? 'png' : 'jpeg'
          });
          
          // إضافة الصورة إلى الخلية B (العمود الثاني)
          worksheet.addImage(imageId, {
            tl: { col: 1, row: rowNumber - 1 }, // العمود B (1)، الصف الحالي
            br: { col: 2, row: rowNumber },     // إلى العمود C (2)، الصف التالي
            editAs: 'oneCell'
          });
          
          imageCounter++;
        } catch (e) {
          console.warn('لا يمكن إضافة صورة المنتج:', e);
        }
      }
      
      // إضافة بيانات الصف
      const row = worksheet.addRow([
        index + 1,
        item.image ? '' : '---', // ترك الخلية فارغة إذا كانت هناك صورة
        item.type,
        item.name,
        item.quantity,
        item.unit,
        formatExpiryDate(item.expiry),
        item.company || '-',
        item.batch || '-',
        item.product || '-',
        item.notes || '-'
      ]);

      // ضبط ارتفاع الصف لاستيعاب الصورة
      row.height = 60;

      // تنسيق الصف
      row.eachCell((cell, colNumber) => {
        cell.font = normalFont;
        cell.border = {
          top: { style: 'thin', color: { argb: 'FFDDDDDD' } },
          left: { style: 'thin', color: { argb: 'FFDDDDDD' } },
          bottom: { style: 'thin', color: { argb: 'FFDDDDDD' } },
          right: { style: 'thin', color: { argb: 'FFDDDDDD' } }
        };
        cell.alignment = { 
          horizontal: 'center', 
          vertical: 'middle',
          wrapText: true
        };

        // محاذاة خاصة للأعمدة النصية
        if (colNumber === 4) { // عمود الاسم
          cell.alignment = { horizontal: 'right', vertical: 'middle', wrapText: true };
        }
        if (colNumber === 11) { // عمود الملاحظات
          cell.alignment = { horizontal: 'right', vertical: 'middle', wrapText: true };
        }
      });

      // تلوين الصفوف بنفس ألوان PDF
      if (checkIfExpired(item.expiry)) {
        row.fill = {
          type: 'pattern',
          pattern: 'solid',
          fgColor: { argb: 'FFFFEBEE' } // أحمر فاتح
        };
      } else if (parseInt(item.quantity) < 10) {
        row.fill = {
          type: 'pattern',
          pattern: 'solid',
          fgColor: { argb: 'FFFFF3E0' } // برتقالي فاتح
        };
      }

      // تلوين تاريخ الانتهاء إذا كان منتهيًا
      const expiryCell = row.getCell(7);
      if (checkIfExpired(item.expiry)) {
        expiryCell.font = { name: 'Cairo', size: 10, bold: true, color: { argb: 'FFE74C3C' } };
      }
    }

    // === ضبط عرض الأعمدة - نفس نسب PDF ===
    worksheet.columns = [
      { width: 5 },   // م (3%)
      { width: 15 },  // الصورة (7%) - زيادة العرض لاستيعاب الصور
      { width: 10 },  // النوع (8%)
      { width: 25 },  // الاسم (15%)
      { width: 8 },   // الكمية (5%)
      { width: 10 },  // الوحدة (6%)
      { width: 12 },  // تاريخ الانتهاء (8%)
      { width: 15 },  // الشركة (10%)
      { width: 12 },  // رقم التشغيلة (8%)
      { width: 12 },  // رقم المنتج (10%)
      { width: 30 }   // الملاحظات (20%)
    ];

    // ضبط ارتفاع الصفوف
    worksheet.getRow(1).height = 25;
    worksheet.getRow(4).height = 30;
    worksheet.getRow(5).height = 25;
    worksheet.getRow(6).height = 25;
    headerRow.height = 30;

    // === التوقيعات - مع الأسماء ===
    const lastRow = worksheet.lastRow.number + 2;

    // توقيع المشرف مع الاسم
    worksheet.mergeCells(`A${lastRow}:E${lastRow}`);
    const supervisorTitle = worksheet.getCell(`A${lastRow}`);
    supervisorTitle.value = 'توقيع مشرف المختبر';
    supervisorTitle.font = { name: 'Cairo', size: 12, bold: true, color: { argb: 'FF000000' } }; // أسود
    supervisorTitle.alignment = { horizontal: 'center', vertical: 'middle' };

    worksheet.mergeCells(`A${lastRow + 1}:E${lastRow + 1}`);
    const supervisorName = worksheet.getCell(`A${lastRow + 1}`);
    supervisorName.value = 'د. هشام المهدي';
    supervisorName.font = { name: 'Cairo', size: 11, color: { argb: 'FF000000' } }; // أسود
    supervisorName.alignment = { horizontal: 'center', vertical: 'middle' };

    // توقيع المدير مع الاسم
    worksheet.mergeCells(`G${lastRow}:K${lastRow}`);
    const directorTitle = worksheet.getCell(`G${lastRow}`);
    directorTitle.value = 'توقيع مدير المختبر';
    directorTitle.font = { name: 'Cairo', size: 12, bold: true, color: { argb: 'FF000000' } }; // أسود
    directorTitle.alignment = { horizontal: 'center', vertical: 'middle' };

    worksheet.mergeCells(`G${lastRow + 1}:K${lastRow + 1}`);
    const directorName = worksheet.getCell(`G${lastRow + 1}`);
    directorName.value = 'د. أيمن العفيفي';
    directorName.font = { name: 'Cairo', size: 11, color: { argb: 'FF000000' } }; // أسود
    directorName.alignment = { horizontal: 'center', vertical: 'middle' };

    // === التذييل - نفس تنسيق PDF ===
    const footerRow = lastRow + 3;
    worksheet.mergeCells(`A${footerRow}:K${footerRow}`);
    const footer = worksheet.getCell(`A${footerRow}`);
    footer.value = `تم إنشاء هذا التقرير بواسطة نظام جرد المختبر - Inventory Advance 2025 ${imageCounter > 0 ? `(تم إضافة ${imageCounter} صورة)` : ''}`;
    footer.font = smallFont;
    footer.alignment = { horizontal: 'center', vertical: 'middle' };
    footer.fill = {
      type: 'pattern',
      pattern: 'solid',
      fgColor: { argb: 'FFF5F5F5' }
    };

    // حفظ الملف
    const buffer = await workbook.xlsx.writeBuffer();
    const blob = new Blob([buffer], {
      type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
    });

    // حفظ محلي
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `جرد_المختبر_${new Date().toISOString().slice(0, 10)}.xlsx`;
    link.click();

    const timestamp = new Date().toISOString().slice(0,16).replace(/[:T]/g,'-');
    const filename = `جرد_المختبر_${timestamp}.xlsx`;
    const uploadSuccess = await uploadIfAllowed(
      blob, 
      `exports/${filename}`,
      `تصدير Excel من نظام الجرد - ${new Date().toLocaleDateString('ar-EG')}`
    );

    showLoading(false);

    if (uploadSuccess) {
      notify(`✅ تم تصدير Excel مع ${imageCounter} صورة ورفعه إلى GitHub بنجاح`, 'success');
    } else {
      notify(`💾 تم تصدير Excel مع ${imageCounter} صورة محلياً فقط`, 'success');
    }

  } catch (error) {
    console.error('خطأ في تصدير Excel:', error);
    showLoading(false);
    notify('حدث خطأ أثناء إنشاء ملف Excel', 'error');
  }
}
    function printTable(){ window.print(); }

    // Sample data and clear
    function addSampleData(){ 
      const sample = [ 
        {type:'لقاح',name:'لقاح الحمى القلاعية',quantity:50,unit:'قارورة',expiry:'2026-06',company:'شركة أ',batch:'B123'},
        {type:'مشخصات اليزا',name:'Rift valley competition elisa',quantity:5,unit:'باكت',expiry:'2024-12',company:'مختبر ب',batch:'EL-01'} 
      ]; 
      sample.forEach(s=>{ 
        db.run('INSERT INTO inventory (type,name,quantity,unit,expiry,company,batch) VALUES (?,?,?,?,?,?,?)',
          [s.type,s.name,s.quantity,s.unit,s.expiry,s.company,s.batch]); 
      }); 
      saveDatabaseToStorage(); 
      loadInventory(); 
      notify('تم إضافة بيانات تجريبية','success'); 
    }
    
    function clearData(){ 
      if(confirm('هل تريد مسح جميع البيانات؟')){ 
        db.run('DELETE FROM inventory'); 
        saveDatabaseToStorage(); 
        loadInventory(); 
        notify('تم مسح البيانات','success'); 
      } 
    }

    // Theme
    function toggleTheme(){ 
      document.documentElement.classList.toggle('dark-theme'); 
      localStorage.setItem('theme', document.documentElement.classList.contains('dark-theme')? 'dark':'light'); 
    }
    
    function loadTheme(){ 
      const t = localStorage.getItem('theme') || 'light'; 
      if(t==='dark') document.documentElement.classList.add('dark-theme'); 
    }

    // Utilities
    function todayDateString(){ const d=new Date(); return d.toISOString().slice(0,10); }

    // Notifications
    let notifTimer = null;
    function notify(message,type='success'){ 
      const n=document.getElementById('notification'); 
      const msg=document.getElementById('notificationMessage'); 
      msg.textContent = message; 
      n.classList.add('show'); 
      if(type==='error') n.style.backgroundColor='var(--danger)'; 
      else if(type==='warning') n.style.backgroundColor='var(--warning)'; 
      else n.style.backgroundColor='var(--success)'; 
      clearTimeout(notifTimer); 
      notifTimer = setTimeout(()=> hideNotification(), 4000); 
    }
    
    function hideNotification(){ 
      const n=document.getElementById('notification'); 
      n.classList.remove('show'); 
    }

    function showLoading(state){ 
      const l=document.getElementById('loadingOverlay'); 
      if(state) l.classList.add('show'); 
      else l.classList.remove('show'); 
    }

    // --- Save mode (local / github / both) helpers ---
    function getSaveMode(){
      return localStorage.getItem('inventory_save_mode') || 'both';
    }
    
    function applySaveModeToUI(){
      const mode = getSaveMode();
      document.getElementById('saveLocal').checked = mode==='local';
      document.getElementById('saveGithub').checked = mode==='github';
      document.getElementById('saveBoth').checked = mode==='both';
      const hint = document.getElementById('saveModeHint');
      if(mode==='local') hint.textContent = 'سيتم حفظ الملفات محليًا فقط.';
      else if(mode==='github') hint.textContent = 'سيتم رفع الملفات إلى GitHub فقط.';
      else hint.textContent = 'سيتم حفظ الملفات محليًا ورفعها إلى GitHub.';
    }
    
    function setSaveMode(mode){
      localStorage.setItem('inventory_save_mode', mode);
      applySaveModeToUI();
      notify('تم تغيير وضع الحفظ إلى: ' + (mode==='both'?'محلي + GitHub': mode==='local'?'محلي فقط':'GitHub فقط'), 'success');
    }

    // GitHub connection
    window._inventorySessionToken = localStorage.getItem('inventory_github_token') || null;
    window._inventoryGithubOwner = "afifiayman";
    window._inventoryGithubRepo = "inventory-lab-system";

    async function testGithubConnection(){
      const statusEl = document.getElementById('testGithubStatus');
      statusEl.textContent = 'جاري التحقق...';
      try{
        const tokenInputEl = document.getElementById('githubTokenInput');
        if(tokenInputEl && tokenInputEl.value && tokenInputEl.value.trim()!==''){
          window._inventorySessionToken = tokenInputEl.value.trim();
          localStorage.setItem('inventory_github_token', window._inventorySessionToken);
        } else {
          const saved = localStorage.getItem('inventory_github_token');
          if(saved) window._inventorySessionToken = saved;
        }

        if(!window._inventorySessionToken){ 
          statusEl.textContent = 'لم يتم إدخال توكن الجلسة.'; 
          notify('لم يتم إدخال توكن الجلسة','error'); 
          return false; 
        }

        const url = `https://api.github.com/repos/${window._inventoryGithubOwner}/${window._inventoryGithubRepo}`;
        const res = await fetch(url, { 
          headers: { 
            'Authorization': 'Bearer ' + window._inventorySessionToken, 
            'Accept':'application/vnd.github.v3+json' 
          } 
        });

        if(res.ok){
          statusEl.textContent = '✅ تم الاتصال بالمستودع.';
          notify('تم الاتصال بـ GitHub بنجاح', 'success');
          return true;
        } else {
          let body = '';
          try { body = await res.text(); } catch(e){ body = ''; }
          let reason = '';
          if(res.status===401) reason = 'رمز التوكن غير صالح أو منتهي (401 Unauthorized).';
          else if(res.status===403) reason = 'ليس لديك صلاحية الوصول أو تم حظر الطلب (403 Forbidden).';
          else if(res.status===404) reason = 'المستودع غير موجود أو المسار خاطئ (404 Not Found).';
          else reason = `خطأ: (${res.status})`;
          statusEl.textContent = '❌ ' + reason;
          notify('فشل الاتصال بـ GitHub: ' + reason, 'error');
          console.error('testGithubConnection fail', res.status, body);
          return false;
        }
      }catch(e){
        statusEl.textContent = 'خطأ في الاتصال: ' + (e && e.message ? e.message : e);
        notify('خطأ في اختبار الاتصال: ' + (e && e.message ? e.message : e), 'error');
        console.error(e);
        return false;
      }
    }

    // Auto GitHub upload - النسخة المحسنة
    async function uploadToGitHub(blob, pathInRepo, message) {
        console.log('📱 بدء الرفع من الموبايل...');
        
        if (!window._inventorySessionToken) {
            console.error('❌ لا يوجد توكن');
            notify('❌ لم يتم إدخال توكن GitHub', 'error');
            return false;
        }

        try {
            // تحويل الـ Blob إلى base64
            const arrayBuffer = await blob.arrayBuffer();
            const uint8Array = new Uint8Array(arrayBuffer);
            let binary = '';
            uint8Array.forEach(byte => {
                binary += String.fromCharCode(byte);
            });
            const base64 = btoa(binary);

            const url = `https://api.github.com/repos/${window._inventoryGithubOwner}/${window._inventoryGithubRepo}/contents/${pathInRepo}`;
            
            console.log('📤 جاري رفع:', pathInRepo);

            let sha = null;
            
            // التحقق من وجود الملف
            try {
                const getRes = await fetch(url, { 
                    method: 'GET', 
                    headers: { 
                        'Authorization': 'Bearer ' + window._inventorySessionToken, 
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (getRes.ok) {
                    const fileData = await getRes.json();
                    sha = fileData.sha;
                    console.log('📄 الملف موجود - سيتم تحديثه');
                }
            } catch (e) {
                console.log('📄 الملف غير موجود - سيتم إنشاؤه');
            }

            const body = { 
                message: message || (`رفع ${pathInRepo} من نظام الجرد`), 
                content: base64,
                branch: 'main'
            };
            
            if (sha) body.sha = sha;

            const putRes = await fetch(url, {
                method: 'PUT',
                headers: { 
                    'Authorization': 'Bearer ' + window._inventorySessionToken, 
                    'Content-Type': 'application/json',
                    'Accept': 'application/vnd.github.v3+json'
                },
                body: JSON.stringify(body)
            });

            console.log('📩 استجابة GitHub:', putRes.status);

            if (putRes.ok) {
                console.log('✅ تم الرفع بنجاح');
                return true;
            } else {
                const errorText = await putRes.text();
                console.error('❌ فشل الرفع:', putRes.status, errorText);
                
                // رسائل مبسطة للموبايل
                let errorMessage = 'فشل رفع الملف';
                if (putRes.status === 401) errorMessage = 'التوكن منتهي أو غير صالح';
                else if (putRes.status === 403) errorMessage = 'لا يوجد صلاحية للرفع';
                else if (putRes.status === 404) errorMessage = 'المستودع غير موجود';
                
                notify(`❌ ${errorMessage}`, 'error');
                return false;
            }
        } catch (err) {
            console.error('🚨 خطأ:', err);
            notify('❌ حدث خطأ أثناء الرفع', 'error');
            return false;
        }
    }

    async function uploadIfAllowed(blob, path, msg){
        const mode = getSaveMode();
        const hasToken = !!window._inventorySessionToken;
        
        console.log('🔍 تفاصيل الرفع:', {
            mode: mode,
            hasToken: hasToken,
            path: path,
            fileSize: blob.size
        });
        
        if(mode === 'local'){ 
            console.log('💾 Save mode is local - skipping GitHub upload'); 
            return false; 
        }
        
        if(!hasToken){ 
            notify('❌ لم يتم إدخال توكن GitHub - تم حفظ الملف محليًا فقط','warning'); 
            return false; 
        }
        
        // اختبار التوكن أولاً
        const tokenValid = await testGithubConnection();
        if (!tokenValid) {
            notify('❌ التوكن غير صالح - تم حفظ الملف محليًا فقط', 'error');
            return false;
        }
        
        return await uploadToGitHub(blob, path, msg);
    }

    // Load GitHub token on startup
    const savedToken = localStorage.getItem('inventory_github_token');
    if(savedToken){
      window._inventorySessionToken = savedToken;
      document.getElementById('githubTokenInput').value = savedToken;
    }
  </script>
</body>
</html>