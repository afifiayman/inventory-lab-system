<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ù†Ø¸Ø§Ù… Ø§Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®ØªØ¨Ø± - Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/exceljs@4.3.0/dist/exceljs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sql.js@1.8.0/dist/sql-wasm.js"></script>
  <style>
    :root{ --primary:#2b7bd3; --secondary:#58a6ff; --success:#27ae60; --danger:#e74c3c; --warning:#f39c12; --bg:#f3f7fb; --card:#fff; --text:#123; --border:#e6f0fb; --radius:12px; --shadow:0 6px 18px rgba(43,123,211,0.06); }
    .dark-theme{ --primary:#58a6ff; --bg:#2c3e50; --card:#34495e; --text:#ecf0f1; --border:#4a5f7a }
    *{box-sizing:border-box;font-family:'Cairo',sans-serif}
    body{margin:0;min-height:100vh;background:var(--bg);color:var(--text)}
    .app-header{background:linear-gradient(90deg,var(--primary),var(--secondary));color:#fff;padding:12px 16px;position:sticky;top:0;z-index:120}
    .header-content{display:flex;justify-content:space-between;align-items:center;gap:12px}
    .logo-area{display:flex;align-items:center;gap:12px}
    .lab-logo{width:72px;height:56px;background:#fff;border-radius:8px;overflow:hidden;display:flex;align-items:center;justify-content:center}
    .lab-logo img{max-width:100%;max-height:100%;object-fit:contain}
    .app-title{font-weight:800}
    .app-sub{font-size:0.85em;opacity:.95}
    
    /* Ø¥Ø¶Ø§ÙØ© Ø³ØªØ§ÙŠÙ„ Ù„Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ© ÙˆØ§Ù„ØªØ§Ø±ÙŠØ® */
    .operation-selector {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-left: 20px;
      flex-wrap: wrap;
    }
    .operation-selector select, .operation-selector input {
      padding: 8px 12px;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.3);
      background: rgba(255,255,255,0.15);
      color: white;
      font-weight: 600;
    }
    .operation-selector select option {
      color: #333;
    }
    .operation-selector input {
      width: 150px;
    }
    .operation-selector input::-webkit-calendar-picker-indicator {
      filter: invert(1);
    }
    
    .app-nav{display:flex;background:var(--card);border-bottom:1px solid var(--border);position:sticky;top:80px;z-index:100}
    .nav-item{flex:1;text-align:center;padding:10px;font-weight:700;color:#6b7b8a;cursor:pointer;border:none;background:none}
    .nav-item.active{color:var(--primary);border-bottom:3px solid var(--primary)}
    .app-content{padding:16px;padding-bottom:120px}
    .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);margin-bottom:16px}
    .card-header{padding:12px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;font-weight:800}
    .card-body{padding:12px}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:10px;border:none;cursor:pointer;font-weight:700}
    .btn-primary{background:var(--primary);color:#fff}
    .btn-success{background:var(--success);color:#fff}
    .btn-danger{background:var(--danger);color:#fff}
    .btn-warning{background:var(--warning);color:#fff}
    .btn-light{background:var(--card);color:var(--text);border:1px solid var(--border)}
    .btn-outline{background:transparent;border:1px solid var(--primary);color:var(--primary)}
    .form-control{width:100%;padding:10px;border:1px solid var(--border);border-radius:8px;background:#fff;color:var(--text)}
    .form-group{margin-bottom:12px}
    .table{width:100%;border-collapse:collapse;font-size:13px;min-width:600px}
    .table th,.table td{padding:10px;border-bottom:1px solid var(--border);text-align:center}
    .table-img{width:80px;height:60px;object-fit:cover;border-radius:6px}
    .stats-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:12px}
    .stat-card{background:var(--card);padding:12px;border-radius:8px;text-align:center}
    .stat-value{font-size:20px;font-weight:900;color:var(--primary)}
    .image-preview{width:100%;max-width:250px;height:150px;border:2px dashed var(--border);border-radius:10px;display:flex;align-items:center;justify-content:center;background:#fff;margin-bottom:10px;overflow:hidden}
    .signature-preview{width:150px;height:80px;border:1px solid var(--border);margin:0 auto 10px;display:flex;align-items:center;justify-content:center;background:#fff}
    .notification{position:fixed;top:18px;left:18px;right:18px;padding:12px;border-radius:10px;background:var(--success);color:#fff;display:flex;justify-content:space-between;z-index:2000;transform:translateY(-120px);opacity:0;transition:all .25s}
    .notification.show{transform:translateY(0);opacity:1}
    .loading-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.45);display:none;align-items:center;justify-content:center;z-index:3000;color:#fff}
    .loading-overlay.show{display:flex}
    .app-footer{position:fixed;bottom:0;left:0;right:0;background:var(--card);border-top:1px solid var(--border);display:flex;padding:10px 0;z-index:150}
    .footer-btn{flex:1;display:flex;flex-direction:column;align-items:center;gap:5px;background:none;border:none;color:#6b7b8a;cursor:pointer;padding:8px 0}
    .footer-btn.active{color:var(--primary)}
    .page{display:none}
    .page.active{display:block}
    .upload-placeholder{text-align:center;color:#7f8c8d}
    .upload-placeholder i{font-size:24px;margin-bottom:5px}
    .expired{background-color:#ffebee !important}
    .low-stock{background-color:#fff3e0 !important}
    .page-btn{padding:8px 12px;margin:0 4px;border:1px solid var(--border);background:var(--card);cursor:pointer;border-radius:6px}
    .page-btn.active{background:var(--primary);color:#fff;border-color:var(--primary)}
    .pagination{display:flex;justify-content:center;align-items:center;margin-top:16px;gap:6px}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);border:0}
    .close-app-btn{background:var(--danger);color:#fff;border-radius:8px;padding:8px 16px;border:none;cursor:pointer;font-weight:700;margin-right:8px}
    @media(max-width:900px){ .stats-grid{grid-template-columns:repeat(2,1fr)} .table{min-width:100%} }
    @media print{ .app-nav,.app-footer,.btn,.action-buttons,#notification,.loading-overlay{display:none !important} }
    
    /* Ø¥Ø¶Ø§ÙØ© Ø³ØªØ§ÙŠÙ„ Ø®Ø§Øµ Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© ÙÙŠ PDF */
    .pdf-export { background: white; color: black; padding: 20px; direction: rtl; font-family: 'Cairo', sans-serif; }
    .pdf-header { text-align: center; margin-bottom: 20px; border-bottom: 2px solid #2b7bd3; padding-bottom: 15px; }
    .pdf-table { width: 100%; border-collapse: collapse; font-size: 12px; margin: 20px 0; }
    .pdf-table th, .pdf-table td { border: 1px solid #ddd; padding: 8px; text-align: center; }
    .pdf-table th { background-color: #2b7bd3; color: white; }
    .pdf-signatures { display: flex; justify-content: space-between; margin-top: 40px; }
    .pdf-footer { text-align: center; margin-top: 30px; font-size: 10px; color: #666; }
  </style>
</head>
<body>
  <div class="app-container">
    <header class="app-header">
      <div class="header-content">
        <div class="logo-area">
          <div class="lab-logo"><img id="labLogoImg" src="assets/logo.png" alt="Ø´Ø¹Ø§Ø±" onerror="this.style.display='none'"></div>
          <div>
            <div class="app-title">Ù†Ø¸Ø§Ù… Ø§Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®ØªØ¨Ø± - Laboratory management system </div>
            <div class="app-sub">development by afifiayman@gmail.com (version2025) 
          </div>
        </div>
        
        <!-- Ø¥Ø¶Ø§ÙØ© Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ© ÙˆØ§Ù„ØªØ§Ø±ÙŠØ® -->
        <div class="operation-selector">
          <select id="operationType">
            <option value="Ø¬Ø±Ø¯">Ø¬Ø±Ø¯</option>
            <option value="Ø§Ø³ØªÙ„Ø§Ù…">Ø§Ø³ØªÙ„Ø§Ù…</option>
          </select>
          <input type="date" id="operationDate">
        </div>
        
        <div style="display:flex;gap:8px;align-items:center">
          <button class="close-app-btn" id="closeAppBtn"><i class="fas fa-power-off"></i> Ø¥ØºÙ„Ø§Ù‚</button>
          <button class="btn btn-light" id="toggleThemeBtn" title="ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø³Ù…Ø©"><i class="fas fa-moon"></i></button>
          <button class="btn btn-outline" id="changeLogoBtn"><i class="fas fa-image"></i> ØªØºÙŠÙŠØ± Ø§Ù„Ø´Ø¹Ø§Ø±</button>
        </div>
      </div>
    </header>

    <nav class="app-nav" role="navigation" aria-label="Ø±Ø¦ÙŠØ³ÙŠ">
      <button class="nav-item active" data-page="inventory">Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</button>
      <button class="nav-item" data-page="add">Ø¥Ø¶Ø§ÙØ©</button>
      <button class="nav-item" data-page="reports">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</button>
      <button class="nav-item" data-page="settings">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
    </nav>

    <main class="app-content">
      <section id="inventory" class="page active" aria-live="polite">
        <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:12px">
          <button class="btn btn-primary" id="btnAdd"><i class="fas fa-plus"></i> Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù</button>
          <button class="btn btn-success" id="btnExcel"><i class="fas fa-file-excel"></i> ØªØµØ¯ÙŠØ± Excel</button>
          <button class="btn btn-danger" id="btnPDF"><i class="fas fa-file-pdf"></i> ØªØµØ¯ÙŠØ± PDF</button>
          <button class="btn btn-light" id="btnPrint"><i class="fas fa-print"></i> Ø·Ø¨Ø§Ø¹Ø©</button>
          <button class="btn btn-outline" id="btnExportDB"><i class="fas fa-database"></i> Ù†Ø³Ø® Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
        </div>

        <div class="stats-grid" aria-hidden="false">
          <div class="stat-card"><div class="stat-value" id="totalItems">0</div><div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£ØµÙ†Ø§Ù</div></div>
          <div class="stat-card"><div class="stat-value" id="expiredItems">0</div><div class="stat-label">Ù…Ù†ØªÙ‡ÙŠ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©</div></div>
          <div class="stat-card"><div class="stat-value" id="lowStockItems">0</div><div class="stat-label">Ù…Ù†Ø®ÙØ¶ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</div></div>
          <div class="stat-card"><div class="stat-value" id="totalQuantity">0</div><div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ…ÙŠØ©</div></div>
        </div>

        <div class="card" role="region" aria-label="Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ†">
          <div class="card-header">
            <span style="font-size:16px">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</span>
            <div class="search-box">
              <input type="text" id="searchInput" class="form-control" placeholder="Ø¨Ø­Ø«..." />
            </div>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table" id="inventoryTable" aria-describedby="tableDescription">
                <caption id="tableDescription" class="sr-only">Ø¬Ø¯ÙˆÙ„ ÙŠÙˆØ¶Ø­ Ø£ØµÙ†Ø§Ù Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</caption>
                <thead>
                  <tr><th>#</th><th>Ø§Ù„ØµÙˆØ±Ø©</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>Ø§Ù„ÙˆØ­Ø¯Ø©</th><th>Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡</th><th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr>
                </thead>
                <tbody id="inventoryBody"></tbody>
              </table>
            </div>
            <div id="pagination" class="pagination" aria-label="ØªØ±Ù‚ÙŠÙ… Ø§Ù„ØµÙØ­Ø§Øª"></div>
          </div>
        </div>
      </section>

      <section id="add" class="page" aria-hidden="true">
        <div class="card">
          <div class="card-header">
            <span id="formTitle">Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù Ø¬Ø¯ÙŠØ¯</span>
            <button class="btn btn-light" id="backToInventory"><i class="fas fa-arrow-right"></i> Ø±Ø¬ÙˆØ¹</button>
          </div>
          <div class="card-body">
            <form id="addItemForm">
              <input type="hidden" id="editItemId" value="">
              <div class="form-group">
                <label class="form-label">ØµÙˆØ±Ø© Ø§Ù„ØµÙ†Ù</label>
                <div class="image-upload">
                  <div class="image-preview" id="imagePreview"><div class="upload-placeholder"><i class="fas fa-image"></i><div>Ø§Ù†Ù‚Ø± Ù„Ø±ÙØ¹ ØµÙˆØ±Ø©</div></div></div>
                  <input type="file" id="imageInput" accept="image/*" style="display:none;">
                  <button type="button" class="btn btn-outline" id="pickImageBtn"><i class="fas fa-upload"></i> Ø±ÙØ¹ ØµÙˆØ±Ø©</button>
                  <small>Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 2MB. JPG/PNG</small>
                </div>
              </div>

              <div class="form-group"><label class="form-label">Ù†ÙˆØ¹ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</label>
                <select class="form-control" id="itemType" required>
                  <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù†ÙˆØ¹</option>
                  <option>Ù…Ø´Ø®ØµØ§Øª Ø§Ù„ÙŠØ²Ø§</option><option>Ù„Ù‚Ø§Ø­</option><option>ÙƒØ§Ø´Ù</option><option>Ù…ØµÙ„</option><option>Ù…Ø³ØªÙ†Ø¨Øª</option><option>Ø£Ø®Ø±Ù‰</option>
                </select>
              </div>

              <div class="form-group"><label class="form-label">Ø§Ø³Ù… Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</label>
                <select class="form-control" id="itemName" required>
                  <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø§Ø³Ù…</option>
                  <option>Rift valley competition elisa</option>
                  <option>FMD NSP competition elisa</option>
                  <option>Bluetongue competition elisa</option>
                  <option>PPR competition elisa</option>
                  <option>RBT rose bengal antigen</option>
                  <option>Ù„Ù‚Ø§Ø­ Ø§Ù„Ø­Ù…Ù‰ Ø§Ù„Ù‚Ù„Ø§Ø¹ÙŠØ©</option>
                  <option>Ù„Ù‚Ø§Ø­ Ø§Ù„Ø¬Ø¯Ø±ÙŠ</option>
                  <option>Ù…ØµÙ„ Ø§Ù„Ø¨Ø±ÙˆØ³ÙŠÙ„Ø§</option>
                  <option>Ù…Ø³ØªÙ†Ø¨Øª Ø§Ù„Ø®Ù„Ø§ÙŠØ§</option>
                  <option>Ø£Ø®Ø±Ù‰</option>
                </select>
                <input type="text" class="form-control mt-2" id="customItemName" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ù…Ø®ØµØµ" style="display:none;">
              </div>

              <div class="form-group"><label class="form-label">Ø§Ù„ÙƒÙ…ÙŠØ©</label><input type="number" class="form-control" id="itemQuantity" min="0" required></div>
              <div class="form-group"><label class="form-label">Ø§Ù„ÙˆØ­Ø¯Ø©</label>
                <select class="form-control" id="itemUnit" required>
                  <option value="">Ø§Ø®ØªØ± Ø§Ù„ÙˆØ­Ø¯Ø©</option><option>Ø¨Ø§ÙƒØª</option><option>Ù‚Ø§Ø±ÙˆØ±Ø©</option><option>Ø¬Ø±Ø¹Ø©</option><option>Ø¹Ù„Ø¨Ø©</option><option>ÙƒÙŠØ³</option><option>Ù„ØªØ±</option><option>Ù…Ù„Ù„ÙŠ Ù„ØªØ±</option><option>Ø£Ø®Ø±Ù‰</option>
                </select>
              </div>
              <div class="form-group"><label class="form-label">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡</label><input type="month" class="form-control" id="itemExpiry" required></div>
              <div class="form-group"><label class="form-label">Ø§Ù„Ø´Ø±ÙƒØ© Ø§Ù„Ù…Ù†ØªØ¬Ø©</label><input type="text" class="form-control" id="itemCompany"></div>
              <div class="form-group"><label class="form-label">Ø±Ù‚Ù… Ø§Ù„ØªØ´ØºÙŠÙ„Ø©</label><input type="text" class="form-control" id="itemBatch"></div>
              <div class="form-group"><label class="form-label">Ø±Ù‚Ù… Ø§Ù„Ù…Ù†ØªØ¬</label><input type="text" class="form-control" id="itemProduct"></div>
              <div class="form-group"><label class="form-label">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label><textarea class="form-control" id="itemNotes"></textarea></div>

              <div style="display:flex;gap:8px;flex-wrap:wrap">
                <button type="submit" class="btn btn-success"><i class="fas fa-save"></i> Ø­ÙØ¸ Ø§Ù„ØµÙ†Ù</button>
                <button type="button" class="btn btn-light" id="resetFormBtn"><i class="fas fa-undo"></i> Ù…Ø³Ø­ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬</button>
              </div>
            </form>
          </div>
        </div>
      </section>

      <section id="reports" class="page" aria-hidden="true">
        <div class="card"><div class="card-header">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</div><div class="card-body">
          <div class="stats-grid">
            <div class="stat-card"><div class="stat-value" id="reportTotal">0</div><div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£ØµÙ†Ø§Ù</div></div>
            <div class="stat-card"><div class="stat-value" id="reportExpired">0</div><div class="stat-label">Ù…Ù†ØªÙ‡ÙŠ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©</div></div>
            <div class="stat-card"><div class="stat-value" id="reportLowStock">0</div><div class="stat-label">Ù…Ù†Ø®ÙØ¶ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</div></div>
            <div class="stat-card"><div class="stat-value" id="reportTypes">0</div><div class="stat-label">Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ù†ÙˆØ§Ø¹</div></div>
          </div>
          <div id="reportContent"></div>
        </div></div>
      </section>

      <section id="settings" class="page" aria-hidden="true">
        <div class="card"><div class="card-header">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</div><div class="card-body">
          <div class="form-group">
            <label class="form-label">Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠ / Ø§Ø³ØªÙŠØ±Ø§Ø¯</label>
            <div style="display:flex;gap:8px;flex-wrap:wrap"><button class="btn btn-success" id="exportDbBtn"><i class="fas fa-download"></i> ØªØµØ¯ÙŠØ± Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button><button class="btn btn-primary" id="importDbBtn"><i class="fas fa-upload"></i> Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª</button></div>
           <input type="file" id="importDatabaseInput" accept=".db,.sqlite" style="display:none">
          </div>

          <!-- Ù‚Ø³Ù… Ø§Ù„ØªÙˆØ§Ù‚ÙŠØ¹ ÙˆØ§Ù„Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ø­Ø³Ù† -->
          <div class="form-group">
            <label class="form-label">ØªÙˆØ§Ù‚ÙŠØ¹ ÙˆØ£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠÙ†</label>
            <small style="color: #6b7b8a; display: block; margin-bottom: 10px;">
              Ø³ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù‡Ø°Ù‡ Ø§Ù„ØªÙˆØ§Ù‚ÙŠØ¹ ÙˆØ§Ù„Ø£Ø³Ù…Ø§Ø¡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ ÙÙŠ Ù…Ù„ÙØ§Øª PDF Ùˆ Excel
            </small>
            <div style="display:flex;gap:20px;flex-wrap:wrap;margin-bottom:15px">
              
              <!-- ØªÙˆÙ‚ÙŠØ¹ ÙˆØ£Ø³Ù… Ø§Ù„Ù…Ø¯ÙŠØ± -->
              <div style="min-width:250px;border:1px solid var(--border);padding:15px;border-radius:8px">
                <div class="signature-preview" id="directorSignaturePreview">
                  <div class="upload-placeholder">
                    <i class="fas fa-signature"></i>
                    <div>ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ø¯ÙŠØ±</div>
                  </div>
                </div>
                <div class="form-group" style="margin-top:10px">
                  <label style="font-weight:bold;display:block;margin-bottom:5px">Ø§Ø³Ù… Ø§Ù„Ù…Ø¯ÙŠØ±:</label>
                  <input type="text" class="form-control" id="directorNameInput" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø¯ÙŠØ±" value="Ø¯. Ø£ÙŠÙ…Ù† Ø§Ù„Ø¹ÙÙŠÙÙŠ">
                </div>
                <input type="file" id="directorSignatureInput" accept="image/*" style="display:none">
                <div style="display:flex;gap:6px;margin-top:10px">
                  <button class="btn btn-outline btn-sm" id="uploadDirSigBtn">Ø±ÙØ¹ Ø§Ù„ØªÙˆÙ‚ÙŠØ¹</button>
                  <button class="btn btn-light btn-sm" id="clearDirSigBtn">Ù…Ø³Ø­ Ø§Ù„ØªÙˆÙ‚ÙŠØ¹</button>
                </div>
              </div>

              <!-- ØªÙˆÙ‚ÙŠØ¹ ÙˆØ£Ø³Ù… Ø§Ù„Ù…Ø´Ø±Ù -->
              <div style="min-width:250px;border:1px solid var(--border);padding:15px;border-radius:8px">
                <div class="signature-preview" id="supervisorSignaturePreview">
                  <div class="upload-placeholder">
                    <i class="fas fa-signature"></i>
                    <div>ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ø´Ø±Ù</div>
                  </div>
                </div>
                <div class="form-group" style="margin-top:10px">
                  <label style="font-weight:bold;display:block;margin-bottom:5px">Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±Ù:</label>
                  <input type="text" class="form-control" id="supervisorNameInput" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±Ù" value="Ø¯. Ù‡Ø´Ø§Ù… Ø§Ù„Ù…Ù‡Ø¯ÙŠ">
                </div>
                <input type="file" id="supervisorSignatureInput" accept="image/*" style="display:none">
                <div style="display:flex;gap:6px;margin-top:10px">
                  <button class="btn btn-outline btn-sm" id="uploadSupSigBtn">Ø±ÙØ¹ Ø§Ù„ØªÙˆÙ‚ÙŠØ¹</button>
                  <button class="btn btn-light btn-sm" id="clearSupSigBtn">Ù…Ø³Ø­ Ø§Ù„ØªÙˆÙ‚ÙŠØ¹</button>
                </div>
              </div>

            </div>
            
            <!-- Ù‚Ø³Ù… Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ØªÙˆØ§Ù‚ÙŠØ¹ Ù…Ø¹ GitHub -->
            <div class="form-group">
              <label class="form-label">Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ØªÙˆØ§Ù‚ÙŠØ¹ Ù…Ø¹ GitHub</label>
              <div style="display:flex;gap:8px;flex-wrap:wrap">
                <button class="btn btn-outline" id="uploadSignaturesToGithubBtn">
                  <i class="fas fa-cloud-upload-alt"></i> Ø±ÙØ¹ Ø§Ù„ØªÙˆØ§Ù‚ÙŠØ¹ Ø¥Ù„Ù‰ GitHub
                </button>
                <button class="btn btn-light" id="downloadSignaturesFromGithubBtn">
                  <i class="fas fa-cloud-download-alt"></i> ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙˆØ§Ù‚ÙŠØ¹ Ù…Ù† GitHub
                </button>
              </div>
              <small style="color:#6b7b8a">Ù…Ø³Ø§Ø± Ø§Ù„ØªÙˆØ§Ù‚ÙŠØ¹ ÙÙŠ GitHub: assets/signatures/</small>
            </div>
          </div>

          <!-- Ø¥Ø¶Ø§ÙØ© Ù‚Ø³Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø´Ø¹Ø§Ø± -->
          <div class="form-group">
            <label class="form-label">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø´Ø¹Ø§Ø±</label>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <button class="btn btn-outline" id="uploadLogoToGithubBtn">
                <i class="fas fa-cloud-upload-alt"></i> Ø±ÙØ¹ Ø§Ù„Ø´Ø¹Ø§Ø± Ø¥Ù„Ù‰ GitHub
              </button>
              <button class="btn btn-light" id="syncLogoFromGithubBtn">
                <i class="fas fa-cloud-download-alt"></i> ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø´Ø¹Ø§Ø± Ù…Ù† GitHub
              </button>
            </div>
            <small style="color:#6b7b8a">Ù…Ø³Ø§Ø± Ø§Ù„Ø´Ø¹Ø§Ø± ÙÙŠ GitHub: assets/logo.png</small>
          </div>

          <div class="form-group"><label class="form-label">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø­ÙØ¸</label>
            <div style="display:flex;gap:12px;flex-direction:column;max-width:400px">
              <label><input type="radio" name="saveMode" value="local" id="saveLocal"> ğŸ’¾ Ø­ÙØ¸ Ù…Ø­Ù„ÙŠ ÙÙ‚Ø·</label>
              <label><input type="radio" name="saveMode" value="github" id="saveGithub"> â˜ï¸ Ø±ÙØ¹ Ø¥Ù„Ù‰ GitHub ÙÙ‚Ø·</label>
              <label><input type="radio" name="saveMode" value="both" id="saveBoth"> ğŸ”„ Ù…Ø­Ù„ÙŠ + GitHub</label>
              <small id="saveModeHint" style="color:#6b7b8a;margin-top:6px"></small>
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">GitHub Token</label>
            <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
              <input id="githubTokenInput" class="form-control" placeholder="Ø£Ø¯Ø®Ù„ ØªÙˆÙƒÙ† GitHub Ù‡Ù†Ø§ (ghp_...)" value="">
              <button class="btn btn-outline" id="saveGithubTokenBtn"><i class="fas fa-save"></i> Ø­ÙØ¸ Ø§Ù„ØªÙˆÙƒÙ†</button>
              <button class="btn btn-light" id="clearGithubTokenBtn"><i class="fas fa-trash"></i> Ù…Ø³Ø­ Ø§Ù„ØªÙˆÙƒÙ†</button>
            </div>
            <small style="color:#6b7b8a">Ø³ÙŠØ­ÙØ¸ Ø§Ù„ØªÙˆÙƒÙ† ÙÙŠ Ù…ØªØµÙØ­Ùƒ (Local Storage) Ù„ØªØ¬Ø±Ø¨Ø© Ø³Ù‡Ù„Ø© Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„.</small>
          </div>

          <div class="form-group" style="display:flex;gap:8px;align-items:center">
            <button class="btn btn-outline" id="testGithubBtn"><i class="fas fa-link"></i> Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ GitHub</button>
            <div id="testGithubStatus" style="font-weight:700;color:#6b7b8a"></div>
          </div>

          <!-- Ù‚Ø³Ù… ØªØµØ­ÙŠØ­ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ù„Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ -->
          <div class="form-group">
            <label class="form-label">ØªØµØ­ÙŠØ­ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡</label>
            <div style="display:flex;gap:8px;flex-wrap:wrap;flex-direction:column;">
              <button class="btn btn-outline" id="mobileTestToken">
                <i class="fas fa-key"></i> Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØªÙˆÙƒÙ†
              </button>
              <button class="btn btn-outline" id="mobileTestUpload">
                <i class="fas fa-upload"></i> Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø±ÙØ¹
              </button>
              <button class="btn btn-outline" id="mobileShowToken">
                <i class="fas fa-eye"></i> Ø¹Ø±Ø¶ Ø§Ù„ØªÙˆÙƒÙ†
              </button>
              <button class="btn btn-outline" id="mobileCheckRepo">
                <i class="fas fa-folder"></i> Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹
              </button>
            </div>
          </div>

          <div class="form-group"><button class="btn btn-warning" id="btnAddSample">Ø¥Ø¶Ø§ÙØ© Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ©</button><button class="btn btn-danger" id="btnClearData">Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button></div>
        </div></div>
      </section>
    </main>

    <footer class="app-footer" role="navigation" aria-label="ØªØ°ÙŠÙŠÙ„">
      <button class="footer-btn active" data-page="inventory"><i class="fas fa-boxes"></i><span>Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</span></button>
      <button class="footer-btn" data-page="add"><i class="fas fa-plus-circle"></i><span>Ø¥Ø¶Ø§ÙØ©</span></button>
      <button class="footer-btn" data-page="reports"><i class="fas fa-chart-bar"></i><span>Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</span></button>
      <button class="footer-btn" data-page="settings"><i class="fas fa-cog"></i><span>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</span></button>
    </footer>
  </div>

  <div id="notification" class="notification" role="alert" aria-live="assertive"><span id="notificationMessage"></span><button onclick="hideNotification()" style="background:none;border:none;color:#fff;font-size:16px"><i class="fas fa-times"></i></button></div>
  <div id="loadingOverlay" class="loading-overlay"><div style="text-align:center"><div class="loading-spinner" style="width:48px;height:48px;border:5px solid rgba(255,255,255,0.2);border-top-color:#fff;border-radius:50%;animation:spin 1s linear infinite"></div><div style="margin-top:12px">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...</div></div></div>

  <script>
    // Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„ÙƒØ§Ù…Ù„ Ø§Ù„Ù…ØµØ­Ø­ ÙˆØ§Ù„Ù…ØªÙƒØ§Ù…Ù„
    let db = null, SQL = null; 
    let currentInventory = []; 
    let currentPage = 1; 
    const itemsPerPage = 10;

    // ØªØ¹Ø±ÙŠÙ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø®Ø§ØµØ© Ø¨Ù€ GitHub
    window._inventoryGithubOwner = 'afifiayman';
    window._inventoryGithubRepo = 'inventory-lab-system';
    window._inventorySessionToken = localStorage.getItem('inventory_github_token') || null;

    document.addEventListener('DOMContentLoaded', async ()=>{
      // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙˆÙƒÙ† Ø§Ù„Ù…Ø­ÙÙˆØ¸
      const savedToken = localStorage.getItem('inventory_github_token');
      if(savedToken){
        window._inventorySessionToken = savedToken;
        document.getElementById('githubTokenInput').value = savedToken;
      }
      
      wireNavigation();
      await initSQL();
      bindUI();
      loadTheme();
      loadSignaturesAndNames(); // ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«
      
      // ØªØ¹ÙŠÙŠÙ† Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ø­Ø§Ù„ÙŠ ÙƒÙ‚ÙŠÙ…Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('operationDate').value = today;
      
      renderHeaderLogoFromStorage();
      loadInventory();
      applySaveModeToUI();
    });

    // ================= Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªÙˆØ§Ù‚ÙŠØ¹ ÙˆØ§Ù„Ø£Ø³Ù…Ø§Ø¡ =================
    function saveSignaturesAndNames() {
      const directorName = document.getElementById('directorNameInput').value;
      const supervisorName = document.getElementById('supervisorNameInput').value;
      
      localStorage.setItem('directorName', directorName);
      localStorage.setItem('supervisorName', supervisorName);
      
      notify('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ø¨Ù†Ø¬Ø§Ø­', 'success');
    }

    function loadSignaturesAndNames() {
      // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡
      const directorName = localStorage.getItem('directorName') || 'Ø¯. Ø£ÙŠÙ…Ù† Ø§Ù„Ø¹ÙÙŠÙÙŠ';
      const supervisorName = localStorage.getItem('supervisorName') || 'Ø¯. Ù‡Ø´Ø§Ù… Ø§Ù„Ù…Ù‡Ø¯ÙŠ';
      
      document.getElementById('directorNameInput').value = directorName;
      document.getElementById('supervisorNameInput').value = supervisorName;
      
      // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙˆØ§Ù‚ÙŠØ¹
      const dirSig = localStorage.getItem('directorSignature');
      const supSig = localStorage.getItem('supervisorSignature');
      const dPrev = document.getElementById('directorSignaturePreview');
      const sPrev = document.getElementById('supervisorSignaturePreview');
      
      if(dPrev){ 
        dPrev.innerHTML = dirSig ? 
          `<img src="${dirSig}" style="max-width:100%;max-height:100%;object-fit:contain; border-radius:4px;">` : 
          '<div class="upload-placeholder"><i class="fas fa-signature"></i><div>ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ø¯ÙŠØ±</div></div>'; 
      }
      
      if(sPrev){ 
        sPrev.innerHTML = supSig ? 
          `<img src="${supSig}" style="max-width:100%;max-height:100%;object-fit:contain; border-radius:4px;">` : 
          '<div class="upload-placeholder"><i class="fas fa-signature"></i><div>ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ø´Ø±Ù</div></div>'; 
      }
    }

    function getDirectorInfo() {
      return {
        name: localStorage.getItem('directorName') || 'Ø¯. Ø£ÙŠÙ…Ù† Ø§Ù„Ø¹ÙÙŠÙÙŠ',
        signature: localStorage.getItem('directorSignature')
      };
    }

    function getSupervisorInfo() {
      return {
        name: localStorage.getItem('supervisorName') || 'Ø¯. Ù‡Ø´Ø§Ù… Ø§Ù„Ù…Ù‡Ø¯ÙŠ',
        signature: localStorage.getItem('supervisorSignature')
      };
    }

    // ================= Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø´Ø¹Ø§Ø± Ù…Ø¹ GitHub =================
    async function uploadLogoToGitHub() {
      try {
        const logoBase64 = localStorage.getItem('labLogo');
        if (!logoBase64) {
          console.log('No logo found in localStorage');
          notify('âŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø´Ø¹Ø§Ø± Ù…Ø­ÙÙˆØ¸ Ù…Ø­Ù„ÙŠÙ‹Ø§','error');
          return false;
        }

        // ØªØ­ÙˆÙŠÙ„ base64 Ø¥Ù„Ù‰ blob
        const response = await fetch(logoBase64);
        const blob = await response.blob();

        const pathInRepo = 'assets/logo.png';
        const message = 'Ø±ÙØ¹ Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ø®ØªØ¨Ø± Ù…Ù† Ù†Ø¸Ø§Ù… Ø§Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®ØªØ¨Ø±';

        const success = await uploadToGitHub(blob, pathInRepo, message);
        
        if (success) {
          console.log('âœ… ØªÙ… Ø±ÙØ¹ Ø§Ù„Ø´Ø¹Ø§Ø± Ø¥Ù„Ù‰ GitHub Ø¨Ù†Ø¬Ø§Ø­');
          return true;
        } else {
          console.log('âŒ ÙØ´Ù„ Ø±ÙØ¹ Ø§Ù„Ø´Ø¹Ø§Ø± Ø¥Ù„Ù‰ GitHub');
          return false;
        }
      } catch (error) {
        console.error('ğŸš¨ Ø®Ø·Ø£ ÙÙŠ Ø±ÙØ¹ Ø§Ù„Ø´Ø¹Ø§Ø±:', error);
        return false;
      }
    }

    // Ø¯Ø§Ù„Ø© Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø´Ø¹Ø§Ø± Ù…Ù† GitHub
    async function loadLogoFromGitHub() {
      try {
        if (!window._inventorySessionToken) return null;
        
        const url = `https://api.github.com/repos/${window._inventoryGithubOwner}/${window._inventoryGithubRepo}/contents/assets/logo.png`;
        
        const response = await fetch(url, {
          headers: {
            'Authorization': 'Bearer ' + window._inventorySessionToken,
            'Accept': 'application/vnd.github.v3.raw'
          }
        });
        
        if (response.ok) {
          const blob = await response.blob();
          return new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.readAsDataURL(blob);
          });
        }
        return null;
      } catch (error) {
        console.error('Error loading logo from GitHub:', error);
        return null;
      }
    }

    // ================= Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªÙˆØ§Ù‚ÙŠØ¹ Ù…Ø¹ GitHub =================
    async function uploadSignaturesToGitHub() {
      try {
        const directorSig = localStorage.getItem('directorSignature');
        const supervisorSig = localStorage.getItem('supervisorSignature');
        
        if (!directorSig && !supervisorSig) {
          console.log('Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙˆØ§Ù‚ÙŠØ¹ Ù…Ø­ÙÙˆØ¸Ø©');
          notify('âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙˆØ§Ù‚ÙŠØ¹ Ù…Ø­ÙÙˆØ¸Ø© Ù…Ø­Ù„ÙŠÙ‹Ø§','error');
          return false;
        }

        let uploadCount = 0;

        // Ø±ÙØ¹ ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ø¯ÙŠØ±
        if (directorSig) {
          const base64Data = directorSig.split(',')[1];
          const binaryString = atob(base64Data);
          const bytes = new Uint8Array(binaryString.length);
          for (let i = 0; i < binaryString.length; i++) {
            bytes[i] = binaryString.charCodeAt(i);
          }
          const blob = new Blob([bytes], { type: 'image/png' });

          const success = await uploadToGitHub(
            blob, 
            'assets/signatures/director_signature.png',
            'Ø±ÙØ¹ ØªÙˆÙ‚ÙŠØ¹ Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø®ØªØ¨Ø±'
          );
          
          if (success) uploadCount++;
        }

        // Ø±ÙØ¹ ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ø´Ø±Ù
        if (supervisorSig) {
          const base64Data = supervisorSig.split(',')[1];
          const binaryString = atob(base64Data);
          const bytes = new Uint8Array(binaryString.length);
          for (let i = 0; i < binaryString.length; i++) {
            bytes[i] = binaryString.charCodeAt(i);
          }
          const blob = new Blob([bytes], { type: 'image/png' });

          const success = await uploadToGitHub(
            blob, 
            'assets/signatures/supervisor_signature.png',
            'Ø±ÙØ¹ ØªÙˆÙ‚ÙŠØ¹ Ù…Ø´Ø±Ù Ø§Ù„Ù…Ø®ØªØ¨Ø±'
          );
          
          if (success) uploadCount++;
        }

        return uploadCount > 0;
      } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ Ø±ÙØ¹ Ø§Ù„ØªÙˆØ§Ù‚ÙŠØ¹:', error);
        return false;
      }
    }

    // Ø¯Ø§Ù„Ø© Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙˆØ§Ù‚ÙŠØ¹ Ù…Ù† GitHub
    async function loadSignaturesFromGitHub() {
      try {
        if (!window._inventorySessionToken) return false;

        let loadedCount = 0;

        // ØªØ­Ù…ÙŠÙ„ ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ø¯ÙŠØ±
        try {
          const directorUrl = `https://api.github.com/repos/${window._inventoryGithubOwner}/${window._inventoryGithubRepo}/contents/assets/signatures/director_signature.png`;
          
          const directorResponse = await fetch(directorUrl, {
            headers: {
              'Authorization': 'Bearer ' + window._inventorySessionToken,
              'Accept': 'application/vnd.github.v3.raw'
            }
          });
          
          if (directorResponse.ok) {
            const blob = await directorResponse.blob();
            const reader = new FileReader();
            reader.onload = () => {
              localStorage.setItem('directorSignature', reader.result);
              loadedCount++;
            };
            reader.readAsDataURL(blob);
          }
        } catch (e) {
          console.warn('Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ­Ù…ÙŠÙ„ ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ø¯ÙŠØ± Ù…Ù† GitHub:', e);
        }

        // ØªØ­Ù…ÙŠÙ„ ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ø´Ø±Ù
        try {
          const supervisorUrl = `https://api.github.com/repos/${window._inventoryGithubOwner}/${window._inventoryGithubRepo}/contents/assets/signatures/supervisor_signature.png`;
          
          const supervisorResponse = await fetch(supervisorUrl, {
            headers: {
              'Authorization': 'Bearer ' + window._inventorySessionToken,
              'Accept': 'application/vnd.github.v3.raw'
            }
          });
          
          if (supervisorResponse.ok) {
            const blob = await supervisorResponse.blob();
            const reader = new FileReader();
            reader.onload = () => {
              localStorage.setItem('supervisorSignature', reader.result);
              loadedCount++;
            };
            reader.readAsDataURL(blob);
          }
        } catch (e) {
          console.warn('Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ­Ù…ÙŠÙ„ ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ø´Ø±Ù Ù…Ù† GitHub:', e);
        }

        return loadedCount > 0;
      } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙˆØ§Ù‚ÙŠØ¹:', error);
        return false;
      }
    }

    // Navigation wiring
    function wireNavigation(){
      const btns = document.querySelectorAll('.nav-item, .footer-btn');
      btns.forEach(b=> b.addEventListener('click', ()=>{
        const page = b.getAttribute('data-page');
        showPage(page);
        document.querySelectorAll('.nav-item, .footer-btn').forEach(x=> x.classList.toggle('active', x.getAttribute('data-page')===page));
      }));
      document.getElementById('btnAdd')?.addEventListener('click', ()=> showPage('add'));
      document.getElementById('backToInventory')?.addEventListener('click', ()=> showPage('inventory'));
    }

    function showPage(page){
      document.querySelectorAll('.page').forEach(p=> p.classList.remove('active'));
      const el = document.getElementById(page);
      if(el) el.classList.add('active');
      document.querySelectorAll('.nav-item, .footer-btn').forEach(x=> x.classList.toggle('active', x.getAttribute('data-page')===page));
      if(page==='inventory') document.getElementById('searchInput')?.focus();
    }

    // SQL init + storage
    async function initSQL(){
      showLoading(true);
      try{
        SQL = await initSqlJs({ locateFile: f=>`https://cdn.jsdelivr.net/npm/sql.js@1.8.0/dist/${f}` });
        const saved = localStorage.getItem('inventoryDatabase');
        if(saved){
          const arr = Uint8Array.from(atob(saved), c=>c.charCodeAt(0));
          db = new SQL.Database(arr);
        } else {
          db = new SQL.Database();
          createTables();
        }
        notify('ØªÙ… ØªÙ‡ÙŠØ¦Ø© Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª','success');
      }catch(e){ console.error(e); notify('Ø®Ø·Ø£ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© SQL','error'); }
      finally{ showLoading(false); }
    }

    function createTables(){
      try{
        db.run(`CREATE TABLE IF NOT EXISTS inventory (
          id INTEGER PRIMARY KEY AUTOINCREMENT,
          type TEXT NOT NULL, name TEXT NOT NULL, quantity INTEGER NOT NULL, unit TEXT NOT NULL,
          expiry TEXT, company TEXT, batch TEXT, product TEXT, notes TEXT, image TEXT,
          created_at DATETIME DEFAULT CURRENT_TIMESTAMP, updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
        )`);
        saveDatabaseToStorage();
      }catch(e){ console.error(e); }
    }

    function saveDatabaseToStorage(){
      try{
        const data = db.export();
        const bin = String.fromCharCode(...data);
        localStorage.setItem('inventoryDatabase', btoa(bin));
      }catch(e){ console.error(e); }
    }

    // UI bindings
    function bindUI(){
      document.getElementById('searchInput')?.addEventListener('input', ()=>{ currentPage=1; loadInventory(); });
      document.getElementById('itemName')?.addEventListener('change', function(){ 
        const custom = document.getElementById('customItemName'); 
        if(this.value==='Ø£Ø®Ø±Ù‰'){ custom.style.display='block'; custom.required=true; } 
        else { custom.style.display='none'; custom.required=false; } 
      });
      document.getElementById('imageInput')?.addEventListener('change', e=> handleImageUpload(e));
      document.getElementById('pickImageBtn')?.addEventListener('click', ()=> document.getElementById('imageInput').click());
      document.getElementById('addItemForm')?.addEventListener('submit', e=>{ e.preventDefault(); saveItem(); });
      document.getElementById('resetFormBtn')?.addEventListener('click', ()=> resetForm());
      document.getElementById('btnExcel')?.addEventListener('click', ()=> exportToExcel());
      document.getElementById('btnPDF')?.addEventListener('click', ()=> exportToPDF());
      document.getElementById('btnPrint')?.addEventListener('click', ()=> printTable());
      document.getElementById('btnExportDB')?.addEventListener('click', ()=> exportDatabase());
      document.getElementById('exportDbBtn')?.addEventListener('click', ()=> exportDatabase());
      document.getElementById('importDbBtn')?.addEventListener('click', ()=> document.getElementById('importDatabaseInput').click());
      document.getElementById('importDatabaseInput')?.addEventListener('change', e=> importDatabaseFile(e));
      document.getElementById('uploadDirSigBtn')?.addEventListener('click', ()=> document.getElementById('directorSignatureInput').click());
      document.getElementById('uploadSupSigBtn')?.addEventListener('click', ()=> document.getElementById('supervisorSignatureInput').click());
      document.getElementById('directorSignatureInput')?.addEventListener('change', e=> handleSignatureUpload(e,'director'));
      document.getElementById('supervisorSignatureInput')?.addEventListener('change', e=> handleSignatureUpload(e,'supervisor'));
      document.getElementById('clearDirSigBtn')?.addEventListener('click', ()=> clearSignature('director'));
      document.getElementById('clearSupSigBtn')?.addEventListener('click', ()=> clearSignature('supervisor'));
      document.getElementById('btnAddSample')?.addEventListener('click', ()=> addSampleData());
      document.getElementById('btnClearData')?.addEventListener('click', ()=> clearData());
      document.getElementById('toggleThemeBtn')?.addEventListener('click', ()=> toggleTheme());
      document.getElementById('changeLogoBtn')?.addEventListener('click', ()=> changeLogo());
      document.getElementById('closeAppBtn')?.addEventListener('click', ()=> closeApplication());
      
      // GitHub settings
      document.getElementById('saveLocal')?.addEventListener('change', ()=> setSaveMode('local'));
      document.getElementById('saveGithub')?.addEventListener('change', ()=> setSaveMode('github'));
      document.getElementById('saveBoth')?.addEventListener('change', ()=> setSaveMode('both'));
      document.getElementById('testGithubBtn')?.addEventListener('click', ()=> testGithubConnection());
      
      // Ø­ÙØ¸ Ø§Ù„ØªÙˆÙƒÙ†
      document.getElementById('saveGithubTokenBtn')?.addEventListener('click', function(){
        const tokenValue = document.getElementById('githubTokenInput').value.trim();
        if(!tokenValue){ 
          notify('Ø§Ù„ØªÙˆÙƒÙ† ÙØ§Ø±Øº','warning'); 
          return; 
        }
        localStorage.setItem('inventory_github_token', tokenValue);
        window._inventorySessionToken = tokenValue;
        notify('ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªÙˆÙƒÙ† Ù…Ø­Ù„ÙŠÙ‹Ø§','success');
      });
      
      document.getElementById('clearGithubTokenBtn')?.addEventListener('click', function(){
        localStorage.removeItem('inventory_github_token');
        window._inventorySessionToken = null;
        document.getElementById('githubTokenInput').value = '';
        notify('ØªÙ… Ù…Ø³Ø­ Ø§Ù„ØªÙˆÙƒÙ†','success');
      });

      // Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø´Ø¹Ø§Ø± Ù…Ø¹ GitHub
      document.getElementById('uploadLogoToGithubBtn')?.addEventListener('click', async ()=>{
        if (!localStorage.getItem('labLogo')) {
          notify('âŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø´Ø¹Ø§Ø± Ù…Ø­ÙÙˆØ¸ Ù…Ø­Ù„ÙŠÙ‹Ø§','error');
          return;
        }
        showLoading(true);
        const success = await uploadLogoToGitHub();
        showLoading(false);
        if(success){
          notify('âœ… ØªÙ… Ø±ÙØ¹ Ø§Ù„Ø´Ø¹Ø§Ø± Ø¥Ù„Ù‰ GitHub Ø¨Ù†Ø¬Ø§Ø­','success');
        } else {
          notify('âŒ ÙØ´Ù„ Ø±ÙØ¹ Ø§Ù„Ø´Ø¹Ø§Ø± Ø¥Ù„Ù‰ GitHub','error');
        }
      });

      document.getElementById('syncLogoFromGithubBtn')?.addEventListener('click', async ()=>{
        showLoading(true);
        const logo = await loadLogoFromGitHub();
        showLoading(false);
        if(logo){
          localStorage.setItem('labLogo', logo);
          renderHeaderLogoFromStorage();
          notify('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø´Ø¹Ø§Ø± Ù…Ù† GitHub','success');
        } else {
          notify('âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø´Ø¹Ø§Ø± Ù…Ù† GitHub','error');
        }
      });

      // Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªÙˆØ§Ù‚ÙŠØ¹ Ù…Ø¹ GitHub
      document.getElementById('uploadSignaturesToGithubBtn')?.addEventListener('click', async ()=>{
        showLoading(true);
        const success = await uploadSignaturesToGitHub();
        showLoading(false);
        if(success){
          notify('âœ… ØªÙ… Ø±ÙØ¹ Ø§Ù„ØªÙˆØ§Ù‚ÙŠØ¹ Ø¥Ù„Ù‰ GitHub Ø¨Ù†Ø¬Ø§Ø­','success');
        } else {
          notify('âŒ ÙØ´Ù„ Ø±ÙØ¹ Ø§Ù„ØªÙˆØ§Ù‚ÙŠØ¹ Ø¥Ù„Ù‰ GitHub','error');
        }
      });

      document.getElementById('downloadSignaturesFromGithubBtn')?.addEventListener('click', async ()=>{
        showLoading(true);
        const success = await loadSignaturesFromGitHub();
        showLoading(false);
        if(success){
          loadSignaturesAndNames();
          notify('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙˆØ§Ù‚ÙŠØ¹ Ù…Ù† GitHub Ø¨Ù†Ø¬Ø§Ø­','success');
        } else {
          notify('âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙˆØ§Ù‚ÙŠØ¹ Ù…Ù† GitHub','error');
        }
      });

      // Ø£Ø²Ø±Ø§Ø± ØªØµØ­ÙŠØ­ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ù„Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„
      document.getElementById('mobileTestToken')?.addEventListener('click', async function() {
        showLoading(true);
        const result = await testToken();
        showLoading(false);
        
        if (result) {
          notify('âœ… Ø§Ù„ØªÙˆÙƒÙ† ØµØ§Ù„Ø­', 'success');
        } else {
          notify('âŒ Ø§Ù„ØªÙˆÙƒÙ† ØºÙŠØ± ØµØ§Ù„Ø­', 'error');
        }
      });

      document.getElementById('mobileTestUpload')?.addEventListener('click', async function() {
        showLoading(true);
        
        try {
          const testContent = 'Ø§Ø®ØªØ¨Ø§Ø± Ø±ÙØ¹ Ù…Ù† Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ - ' + new Date().toLocaleString('ar-EG');
          const testBlob = new Blob([testContent], {type: 'text/plain'});
          const path = 'mobile-test-' + Date.now() + '.txt';
          
          const success = await uploadToGitHub(testBlob, path, 'Ø§Ø®ØªØ¨Ø§Ø± Ù…Ù† Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„');
          
          if (success) {
            notify('âœ… âœ… ØªÙ… Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø±ÙØ¹ Ø¨Ù†Ø¬Ø§Ø­!', 'success');
          } else {
            notify('âŒ ÙØ´Ù„ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø±ÙØ¹', 'error');
          }
        } catch (error) {
          notify('ğŸš¨ Ø®Ø·Ø£: ' + error.message, 'error');
        } finally {
          showLoading(false);
        }
      });

      document.getElementById('mobileShowToken')?.addEventListener('click', function() {
        const token = localStorage.getItem('inventory_github_token');
        if (token) {
          // Ø¥Ø¸Ù‡Ø§Ø± Ø£ÙˆÙ„ 10 Ø£Ø­Ø±Ù ÙÙ‚Ø· Ù„Ù„Ø£Ù…Ø§Ù†
          alert('ğŸ”‘ Ø§Ù„ØªÙˆÙƒÙ†: ' + token.substring(0,10) + '...\n\nâœ… Ø§Ù„ØªÙˆÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯ ÙˆÙ…Ø®Ø²Ù†');
        } else {
          alert('âŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªÙˆÙƒÙ† Ù…Ø®Ø²Ù†');
        }
      });

      document.getElementById('mobileCheckRepo')?.addEventListener('click', async function() {
        showLoading(true);
        
        try {
          const token = localStorage.getItem('inventory_github_token');
          if (!token) {
            notify('âŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªÙˆÙƒÙ†', 'error');
            return;
          }
          
          const response = await fetch('https://api.github.com/repos/afifiayman/inventory-lab-system', {
            headers: {
              'Authorization': 'Bearer ' + token,
              'Accept': 'application/vnd.github.v3+json'
            }
          });
          
          if (response.ok) {
            const repo = await response.json();
            notify(`âœ… Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹: ${repo.full_name}\nâ­ Ø§Ù„Ù†Ø¬ÙˆÙ…: ${repo.stargazers_count}\nğŸ”“ ${repo.private ? 'Ø®Ø§Øµ' : 'Ø¹Ø§Ù…'}`, 'success');
          } else {
            notify(`âŒ Ø®Ø·Ø£: ${response.status}`, 'error');
          }
        } catch (error) {
          notify('ğŸš¨ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„', 'error');
        } finally {
          showLoading(false);
        }
      });

      // Ø±Ø¨Ø· Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ø¨Ø­ÙØ¸ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
      document.getElementById('directorNameInput')?.addEventListener('change', saveSignaturesAndNames);
      document.getElementById('supervisorNameInput')?.addEventListener('change', saveSignaturesAndNames);

      document.querySelectorAll('.footer-btn').forEach(b=> b.setAttribute('tabindex', '0'));
    }

    // Ø¯Ø§Ù„Ø© Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØªÙˆÙƒÙ†
    async function testToken() {
        const token = localStorage.getItem('inventory_github_token');
        if (!token) {
            console.error('âŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªÙˆÙƒÙ†');
            notify('âŒ Ù„Ù… ÙŠØªÙ… Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ØªÙˆÙƒÙ†', 'error');
            return false;
        }
        
        console.log('ğŸ”‘ Ø§Ù„ØªÙˆÙƒÙ†:', token.substring(0, 10) + '...');
        
        try {
            const response = await fetch('https://api.github.com/user', {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Accept': 'application/vnd.github.v3+json'
                }
            });
            
            if (response.ok) {
                const userData = await response.json();
                console.log('âœ… Ø§Ù„ØªÙˆÙƒÙ† ØµØ§Ù„Ø­ - Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:', userData.login);
                return true;
            } else {
                console.error('âŒ Ø§Ù„ØªÙˆÙƒÙ† ØºÙŠØ± ØµØ§Ù„Ø­ - Status:', response.status);
                const error = await response.text();
                console.error('ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø®Ø·Ø£:', error);
                return false;
            }
        } catch (error) {
            console.error('ğŸš¨ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„:', error);
            return false;
        }
    }

    // Inventory functions
    function loadInventory(){
      try{
        const term = document.getElementById('searchInput')?.value.trim().toLowerCase() || '';
        let query = 'SELECT * FROM inventory';
        let params = [];
        if(term){ query += ' WHERE name LIKE ? OR type LIKE ? OR company LIKE ?'; params = [`%${term}%`,`%${term}%`,`%${term}%`]; }
        query += ' ORDER BY created_at DESC';
        const res = db.exec(query, params);
        if(res.length>0){
          currentInventory = res[0].values.map(row=>{ const obj={}; res[0].columns.forEach((c,i)=> obj[c]=row[i]); return obj; });
        } else currentInventory = [];
        displayInventoryTable(currentInventory);
        updateStats(currentInventory);
      }catch(e){ console.error(e); notify('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†','error'); }
    }

    function displayInventoryTable(data){
      const tbody = document.getElementById('inventoryBody'); if(!tbody) return; tbody.innerHTML='';
      if(data.length===0){ tbody.innerHTML = `<tr><td colspan="8" style="text-align:center;padding:20px;"><i class="fas fa-box-open" style="font-size:36px;color:#7f8c8d"></i><div>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</div></td></tr>`; document.getElementById('pagination').innerHTML=''; return; }
      const totalPages = Math.ceil(data.length/itemsPerPage);
      const start = (currentPage-1)*itemsPerPage;
      const pageData = data.slice(start, start+itemsPerPage);
      pageData.forEach((it, idx)=>{
        const i = start + idx + 1;
        const expired = checkIfExpired(it.expiry);
        const row = document.createElement('tr'); if(expired) row.classList.add('expired'); else if(parseInt(it.quantity||0)<10) row.classList.add('low-stock');
        row.innerHTML = `<td>${i}</td>
  <td>${it.image?`<img src="${it.image}" class="table-img" style="width:80px;height:60px;object-fit:cover;border-radius:8px">`:'<div style="width:80px;height:60px;background:#f8f8f8;border-radius:8px;display:flex;align-items:center;justify-content:center"><i class="fas fa-image" style="color:#7f8c8d;font-size:20px"></i></div>'}</td>

          <td>${it.type}</td><td>${it.name}</td><td>${it.quantity}</td><td>${it.unit}</td><td>${formatExpiryDate(it.expiry)}</td>
          <td><div style="display:flex;gap:6px;justify-content:center"><button class="btn btn-light" onclick="editItem(${it.id})"><i class="fas fa-edit"></i></button><button class="btn btn-danger" onclick="deleteItem(${it.id})"><i class="fas fa-trash"></i></button></div></td>`;
        tbody.appendChild(row);
      });
      createPagination(totalPages);
    }

    function createPagination(totalPages){
      const div = document.getElementById('pagination'); div.innerHTML='';
      if(totalPages<=1) return;
      const prev = document.createElement('button'); prev.className='page-btn'; prev.innerHTML='<i class="fas fa-chevron-right"></i>'; prev.disabled = currentPage===1; prev.addEventListener('click', ()=>{ if(currentPage>1){ currentPage--; loadInventory(); } }); div.appendChild(prev);
      for(let i=1;i<=totalPages;i++){ const b=document.createElement('button'); b.className=`page-btn ${i===currentPage?'active':''}`; b.textContent=i; b.addEventListener('click', ()=>{ currentPage=i; loadInventory(); }); div.appendChild(b); }
      const next = document.createElement('button'); next.className='page-btn'; next.innerHTML='<i class="fas fa-chevron-left"></i>'; next.disabled = currentPage===totalPages; next.addEventListener('click', ()=>{ if(currentPage<totalPages){ currentPage++; loadInventory(); } }); div.appendChild(next);
    }

    function checkIfExpired(expiry){ if(!expiry) return false; const [y,m]=expiry.split('-').map(Number); const now=new Date(); const cy=now.getFullYear(), cm=now.getMonth()+1; return y<cy || (y===cy && m<cm); }
    function formatExpiryDate(expiry){ if(!expiry) return '-'; const [y,m]=expiry.split('-'); const months=['ÙŠÙ†Ø§ÙŠØ±','ÙØ¨Ø±Ø§ÙŠØ±','Ù…Ø§Ø±Ø³','Ø£Ø¨Ø±ÙŠÙ„','Ù…Ø§ÙŠÙˆ','ÙŠÙˆÙ†ÙŠÙˆ','ÙŠÙˆÙ„ÙŠÙˆ','Ø£ØºØ³Ø·Ø³','Ø³Ø¨ØªÙ…Ø¨Ø±','Ø£ÙƒØªÙˆØ¨Ø±','Ù†ÙˆÙÙ…Ø¨Ø±','Ø¯ÙŠØ³Ù…Ø¨Ø±']; return `${months[parseInt(m)-1]} ${y}`; }

    function updateStats(data){
      const total = data.length;
      const expired = data.filter(i=> checkIfExpired(i.expiry)).length;
      const low = data.filter(i=> parseInt(i.quantity||0) < 10).length;
      const totQty = data.reduce((s,i)=> s + parseInt(i.quantity||0||0), 0);
      document.getElementById('totalItems').textContent = total; document.getElementById('expiredItems').textContent = expired;
      document.getElementById('lowStockItems').textContent = low; document.getElementById('totalQuantity').textContent = totQty;
      if(document.getElementById('reportTotal')) document.getElementById('reportTotal').textContent = total;
      if(document.getElementById('reportExpired')) document.getElementById('reportExpired').textContent = expired;
      if(document.getElementById('reportLowStock')) document.getElementById('reportLowStock').textContent = low;
      if(document.getElementById('reportTypes')) document.getElementById('reportTypes').textContent = new Set(data.map(d=>d.type)).size;
    }

    // CRUD functions
    function saveItem(){
      try{
        const id = document.getElementById('editItemId').value;
        let name = document.getElementById('itemName').value;
        if(name === 'Ø£Ø®Ø±Ù‰') name = document.getElementById('customItemName').value;
        const data = {
          type: document.getElementById('itemType').value,
          name: name,
          quantity: parseInt(document.getElementById('itemQuantity').value||0),
          unit: document.getElementById('itemUnit').value,
          expiry: document.getElementById('itemExpiry').value,
          company: document.getElementById('itemCompany').value,
          batch: document.getElementById('itemBatch').value,
          product: document.getElementById('itemProduct').value,
          notes: document.getElementById('itemNotes').value,
          image: document.getElementById('imagePreview').querySelector('img')?.src || ''
        };
        if(!data.type || !data.name || isNaN(data.quantity) || !data.unit || !data.expiry){ notify('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©','error'); return; }
        if(id){
          db.run('UPDATE inventory SET type=?, name=?, quantity=?, unit=?, expiry=?, company=?, batch=?, product=?, notes=?, image=?, updated_at=CURRENT_TIMESTAMP WHERE id=?',
            [data.type,data.name,data.quantity,data.unit,data.expiry,data.company,data.batch,data.product,data.notes,data.image,id]);
          notify('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙ†Ù','success');
        } else {
          db.run('INSERT INTO inventory (type,name,quantity,unit,expiry,company,batch,product,notes,image) VALUES (?,?,?,?,?,?,?,?,?,?)',
            [data.type,data.name,data.quantity,data.unit,data.expiry,data.company,data.batch,data.product,data.notes,data.image]);
          notify('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµÙ†Ù','success');
        }
        saveDatabaseToStorage();
        resetForm();
        showPage('inventory');
        loadInventory();
      }catch(e){ console.error(e); notify('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„ØµÙ†Ù','error'); }
    }

    function editItem(id){
      try{
        const res = db.exec('SELECT * FROM inventory WHERE id=?', [id]);
        if(res.length>0){
          const itRow = res[0].values[0]; const cols=res[0].columns; const it={}; cols.forEach((c,i)=> it[c]=itRow[i]);
          document.getElementById('editItemId').value = it.id;
          document.getElementById('itemType').value = it.type;
          const known=['Rift valley competition elisa','FMD NSP competition elisa','Bluetongue competition elisa','PPR competition elisa','RBT rose bengal antigen','Ù„Ù‚Ø§Ø­ Ø§Ù„Ø­Ù…Ù‰ Ø§Ù„Ù‚Ù„Ø§Ø¹ÙŠØ©','Ù„Ù‚Ø§Ø­ Ø§Ù„Ø¬Ø¯Ø±ÙŠ','Ù…ØµÙ„ Ø§Ù„Ø¨Ø±ÙˆØ³ÙŠÙ„Ø§','Ù…Ø³ØªÙ†Ø¨Øª Ø§Ù„Ø®Ù„Ø§ÙŠØ§'];
          if(known.includes(it.name)){ document.getElementById('itemName').value = it.name; document.getElementById('customItemName').style.display='none'; } else { document.getElementById('itemName').value='Ø£Ø®Ø±Ù‰'; document.getElementById('customItemName').value=it.name; document.getElementById('customItemName').style.display='block'; }
        document.getElementById('itemQuantity').value = it.quantity;
        document.getElementById('itemUnit').value = it.unit;
        document.getElementById('itemExpiry').value = it.expiry;
        document.getElementById('itemCompany').value = it.company||'';
        document.getElementById('itemBatch').value = it.batch||'';
        document.getElementById('itemProduct').value = it.product||'';
        document.getElementById('itemNotes').value = it.notes||'';
        const prev = document.getElementById('imagePreview'); prev.innerHTML=''; if(it.image){ const img=document.createElement('img'); img.src=it.image; prev.appendChild(img); } else prev.innerHTML='<div class="upload-placeholder"><i class="fas fa-image"></i><div>Ø§Ù†Ù‚Ø± Ù„Ø±ÙØ¹ ØµÙˆØ±Ø©</div></div>';
        document.getElementById('formTitle').textContent = 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØµÙ†Ù';
        showPage('add');
        }
      }catch(e){ console.error(e); notify('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙ†Ù','error'); }
    }

    function deleteItem(id){
      if(confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„ØµÙ†ÙØŸ')){
        try{
          db.run('DELETE FROM inventory WHERE id=?', [id]);
          saveDatabaseToStorage();
          notify('ØªÙ… Ø­Ø°Ù Ø§Ù„ØµÙ†Ù','success');
          loadInventory();
        }catch(e){ console.error(e); notify('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø°Ù','error'); }
      }
    }

    function resetForm(){
      document.getElementById('addItemForm')?.reset();
      document.getElementById('editItemId').value='';
      document.getElementById('customItemName').style.display='none';
      document.getElementById('imagePreview').innerHTML = '<div class="upload-placeholder"><i class="fas fa-image"></i><div>Ø§Ù†Ù‚Ø± Ù„Ø±ÙØ¹ ØµÙˆØ±Ø©</div></div>';
      document.getElementById('formTitle').textContent='Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù Ø¬Ø¯ÙŠØ¯';
    }

    // Image handling
    function handleImageUpload(e, previewId){
      const file = e.target.files[0]; if(!file) return;
      if(!file.type.match('image.*')){ notify('Ø§Ù„Ù…Ù„Ù ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† ØµÙˆØ±Ø©','error'); return; }
      if(file.size>2*1024*1024){ notify('Ø­Ø¬Ù… Ø§Ù„ØµÙˆØ±Ø© Ø£ÙƒØ¨Ø± Ù…Ù† 2MB','error'); return; }
      const reader = new FileReader();
      reader.onload = function(ev){
        const preview = document.getElementById('imagePreview'); preview.innerHTML=''; const img=document.createElement('img'); img.src = ev.target.result; preview.appendChild(img);
      };
      reader.readAsDataURL(file);
    }

    // Signatures & logo
    function handleSignatureUpload(e,type){
      const file = e.target.files[0]; if(!file) return;
      if(!file.type.match('image.*')){ notify('Ø§Ù„Ù…Ù„Ù ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† ØµÙˆØ±Ø©','error'); return; }
      if(file.size>2*1024*1024){ notify('Ø­Ø¬Ù… Ø§Ù„ØµÙˆØ±Ø© Ø£ÙƒØ¨Ø± Ù…Ù† 2MB','error'); return; }
      const reader = new FileReader();
      reader.onload = function(ev){ 
        localStorage.setItem(type+'Signature', ev.target.result); 
        loadSignaturesAndNames(); 
        saveSignaturesAndNames(); // Ø­ÙØ¸ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ø£ÙŠØ¶Ø§Ù‹
        notify('ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªÙˆÙ‚ÙŠØ¹','success'); 
      };
      reader.readAsDataURL(file);
    }

    function clearSignature(type){ 
      localStorage.removeItem(type+'Signature'); 
      loadSignaturesAndNames(); 
      notify('ØªÙ… Ù…Ø³Ø­ Ø§Ù„ØªÙˆÙ‚ÙŠØ¹','success'); 
    }

    function changeLogo(){
      const input = document.createElement('input'); input.type='file'; input.accept='image/*';
      input.onchange = async function(e){
        const f = e.target.files[0]; if(!f) return;
        if(!f.type.match('image.*')){ notify('Ø§Ù„Ù…Ù„Ù ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† ØµÙˆØ±Ø©','error'); return; }
        if(f.size>2*1024*1024){ notify('Ø­Ø¬Ù… Ø§Ù„ØµÙˆØ±Ø© Ø£ÙƒØ¨Ø± Ù…Ù† 2MB','error'); return; }
        const r = new FileReader(); r.onload = async function(ev){
          // Ø­ÙØ¸ Ø§Ù„Ø´Ø¹Ø§Ø± Ù…Ø­Ù„ÙŠÙ‹Ø§
          localStorage.setItem('labLogo', ev.target.result); 
          renderHeaderLogoFromStorage(); 
          
          // Ø±ÙØ¹ Ø§Ù„Ø´Ø¹Ø§Ø± Ø¥Ù„Ù‰ GitHub Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ÙˆØ¶Ø¹ Ù…Ù†Ø§Ø³Ø¨Ù‹Ø§
          const mode = getSaveMode();
          if (mode !== 'local' && window._inventorySessionToken) {
            showLoading(true);
            const uploadSuccess = await uploadLogoToGitHub();
            showLoading(false);
            
            if (uploadSuccess) {
              notify('âœ… ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ø´Ø¹Ø§Ø± ÙˆØ±ÙØ¹Ù‡ Ø¥Ù„Ù‰ GitHub','success');
            } else {
              notify('âš ï¸ ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ø´Ø¹Ø§Ø± Ù…Ø­Ù„ÙŠÙ‹Ø§ ÙˆÙ„ÙƒÙ† ÙØ´Ù„ Ø§Ù„Ø±ÙØ¹ Ø¥Ù„Ù‰ GitHub','warning');
            }
          } else {
            notify('ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ø´Ø¹Ø§Ø± Ù…Ø­Ù„ÙŠÙ‹Ø§','success');
          }
        }; 
        r.readAsDataURL(f);
      };
      input.click();
    }

    function renderHeaderLogoFromStorage(){
      const logo = localStorage.getItem('labLogo');
      const el = document.getElementById('labLogoImg');
      if(el){ if(logo){ el.src = logo; el.style.display='block'; } }
    }

    // Export DB
    function exportDatabase(){
  try{
    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ù…Ù† Ø§Ù„Ù…Ù†Ø³Ø¯Ù„
    const operationType = document.getElementById('operationType').value;
    
    // ØªØ­Ø¯ÙŠØ¯ Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
    let fileName;
    if (operationType === 'Ø§Ø³ØªÙ„Ø§Ù…') {
      fileName = `recive_db_${todayDateString()}.sqlite`;
    } else {
      fileName = `inventory_db_${todayDateString()}.sqlite`;
    }
    
    const data = db.export();
    const blob = new Blob([data], { type: 'application/octet-stream' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); 
    a.href = url; 
    a.download = fileName; 
    document.body.appendChild(a); 
    a.click(); 
    document.body.removeChild(a);
    notify('ØªÙ… ØªÙ†Ø²ÙŠÙ„ Ù†Ø³Ø®Ø© Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª','success');
  }catch(e){ console.error(e); notify('Ø®Ø·Ø£ ÙÙŠ ØªØµØ¯ÙŠØ± Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª','error'); }
}
    function importDatabaseFile(e){
      const file = e.target.files[0]; if(!file) return;
      const reader = new FileReader();
      reader.onload = function(ev){
        try{ const u8 = new Uint8Array(ev.target.result); db = new SQL.Database(u8); saveDatabaseToStorage(); loadInventory(); notify('ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª','success'); }catch(err){ console.error(err); notify('Ø®Ø·Ø£ ÙÙŠ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù…Ù„Ù','error'); }
      };
      reader.readAsArrayBuffer(file);
    }

    // Close application function
    function closeApplication(){
      if(confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ØŸ Ø³ÙŠØªÙ… Ø­ÙØ¸ Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.')){
        saveDatabaseToStorage();
        notify('Ø¬Ø§Ø±ÙŠ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚...', 'success');
        setTimeout(() => {
          document.body.innerHTML = `
            <div style="display: flex; justify-content: center; align-items: center; height: 100vh; background: var(--bg); flex-direction: column; gap: 20px;">
              <div style="font-size: 24px; color: var(--primary); font-weight: bold;">
                ØªÙ… Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¨Ù†Ø¬Ø§Ø­
              </div>
              <div style="color: var(--text);">
                ÙŠÙ…ÙƒÙ†Ùƒ Ø¥ØºÙ„Ø§Ù‚ Ù‡Ø°Ù‡ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¢Ù†
              </div>
              <button onclick="location.reload()" class="btn btn-primary" style="margin-top: 20px;">
                <i class="fas fa-redo"></i> Ø¥Ø¹Ø§Ø¯Ø© ÙØªØ­ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
              </button>
            </div>
          `;
        }, 1500);
      }
    }

    /* ================= ØªØµØ¯ÙŠØ± PDF Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… html2pdf.js ================= */
  async function exportToPDF() {
  try {
    showLoading(true);
    
    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© ÙˆØ§Ù„ØªØ§Ø±ÙŠØ®
    const operationType = document.getElementById('operationType').value;
    const operationDate = document.getElementById('operationDate').value;
    
    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø¯ÙŠØ± ÙˆØ§Ù„Ù…Ø´Ø±Ù Ù…Ù† localStorage
    const directorInfo = getDirectorInfo();
    const supervisorInfo = getSupervisorInfo();
    
    let logo = localStorage.getItem('labLogo');
    // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙˆØ¬Ø¯ Ø§Ù„Ø´Ø¹Ø§Ø± Ù…Ø­Ù„ÙŠÙ‹Ø§ØŒ Ø¬Ø±Ø¨Ù‡ Ù…Ù† GitHub
    if (!logo && window._inventorySessionToken) {
      logo = await loadLogoFromGitHub();
    }
    
    const dateStr = new Date().toLocaleDateString('ar-EG');
    
    // Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù†ØµØ± PDF
    const exportElement = document.createElement('div');
    exportElement.className = 'pdf-export';
    
    exportElement.innerHTML = `
      <div class="pdf-header">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
          <div style="text-align: right; flex: 1;">
            <div style="font-size: 14px; font-weight: bold; margin-bottom: 5px;">Ø§Ù„Ø´Ø±ÙƒØ© Ø§Ù„Ø¯ÙˆÙ„ÙŠØ© Ø§Ù„Ø§ÙˆÙ„Ù‰</div>
            <div style="font-size: 12px;">Ø§Ù„Ù…Ø­Ø¬Ø± Ø§Ù„ØµØ­ÙŠ Ø§Ù„ÙˆØ·Ù†ÙŠ Ø¨Ø±Ø¨Ø±Ø©</div>
          </div>
          
          <div style="flex: 1; text-align: center;">
            ${logo ? `<img src="${logo}" style="max-width: 100px; max-height: 50px; margin: 0 auto;">` : ''}
          </div>
          
          <div style="text-align: left; flex: 1;">
            <div style="font-size: 14px; font-weight: bold; margin-bottom: 5px;">PRIMA INTERNATIONAL COMPANY</div>
            <div style="font-size: 12px;">BERBERA NATIONAL ANIMAL QUARANTINE</div>
          </div>
        </div>
        
        <h1 style="color: #2b7bd3; margin: 10px 0 5px 0;">Ù†Ø¸Ø§Ù… Ø§Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®ØªØ¨Ø±</h1>
        <h2 style="margin: 5px 0 10px 0;">${operationType} Ù…Ø´Ø®ØµØ§Øª ÙˆÙ„Ù‚Ø§Ø­Ø§Øª Ø§Ù„Ù…Ø®ØªØ¨Ø±</h2>
        <div style="font-size: 14px; color: #666;">ØªØ§Ø±ÙŠØ® ${operationType}: ${operationDate}</div>
      </div>
      
      <table class="pdf-table">
        <thead>
          <tr>
            <th style="width: 3%;">Ù…</th>
            <th style="width: 7%;">Ø§Ù„ØµÙˆØ±Ø©</th>
            <th style="width: 8%;">Ø§Ù„Ù†ÙˆØ¹</th>
            <th style="width: 15%;">Ø§Ù„Ø§Ø³Ù…</th>
            <th style="width: 5%;">Ø§Ù„ÙƒÙ…ÙŠØ©</th>
            <th style="width: 6%;">Ø§Ù„ÙˆØ­Ø¯Ø©</th>
            <th style="width: 8%;">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡</th>
            <th style="width: 10%;">Ø§Ù„Ø´Ø±ÙƒØ©</th>
            <th style="width: 8%;">Ø±Ù‚Ù… Ø§Ù„ØªØ´ØºÙŠÙ„Ø©</th>
            <th style="width: 10%;">Ø±Ù‚Ù… Ø§Ù„Ù…Ù†ØªØ¬</th>
            <th style="width: 20%;">Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
          </tr>
        </thead>
        <tbody>
          ${currentInventory.map((item, index) => `
            <tr style="${checkIfExpired(item.expiry) ? 'background-color: #ffebee;' : parseInt(item.quantity) < 10 ? 'background-color: #fff3e0;' : ''}">
              <td>${index + 1}</td>
              <td>${item.image ? `<img src="${item.image}" style="max-width: 50px; max-height: 40px; object-fit: cover; border-radius: 3px;">` : '---'}</td>
              <td>${item.type}</td>
              <td style="text-align: right;">${item.name}</td>
              <td>${item.quantity}</td>
              <td>${item.unit}</td>
              <td style="${checkIfExpired(item.expiry) ? 'color: #e74c3c; font-weight: bold;' : ''}">${formatExpiryDate(item.expiry)}</td>
              <td>${item.company || '-'}</td>
              <td>${item.batch || '-'}</td>
              <td>${item.product || '-'}</td>
              <td style="text-align: right; font-size: 11px;">${item.notes || '-'}</td>
            </tr>
          `).join('')}
        </tbody>
      </table>
      
      <div class="pdf-signatures">
        <div style="text-align: right; flex: 1;">
          ${supervisorInfo.signature ? 
            `<img src="${supervisorInfo.signature}" style="max-width: 120px; max-height: 50px; display: block; margin: 0 auto 5px;">` : 
            '<div style="height: 50px; border-bottom: 1px solid #333; margin-bottom: 5px;"></div>'
          }
          <div style="border-top: 1px solid #333; padding-top: 5px; font-weight: bold;">ØªÙˆÙ‚ÙŠØ¹ Ù…Ø´Ø±Ù Ø§Ù„Ù…Ø®ØªØ¨Ø±</div>
          <div>${supervisorInfo.name}</div>
        </div>
        
        <div style="text-align: left; flex: 1;">
          ${directorInfo.signature ? 
            `<img src="${directorInfo.signature}" style="max-width: 120px; max-height: 50px; display: block; margin: 0 auto 5px;">` : 
            '<div style="height: 50px; border-bottom: 1px solid #333; margin-bottom: 5px;"></div>'
          }
          <div style="border-top: 1px solid #333; padding-top: 5px; font-weight: bold;">ØªÙˆÙ‚ÙŠØ¹ Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø®ØªØ¨Ø±</div>
          <div>${directorInfo.name}</div>
        </div>
      </div>
      
      <div class="pdf-footer">
        ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù‡Ø°Ø§ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¨ÙˆØ§Ø³Ø·Ø© Ù†Ø¸Ø§Ù… Ø§Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®ØªØ¨Ø± - Laboratory Management System 2025
      </div>
    `;

    document.body.appendChild(exportElement);

    // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù Ù…Ø¹ Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª
    const now = new Date();
    const timestamp = `${now.getFullYear()}-${(now.getMonth()+1).toString().padStart(2,'0')}-${now.getDate().toString().padStart(2,'0')}_${now.getHours().toString().padStart(2,'0')}-${now.getMinutes().toString().padStart(2,'0')}`;
    const filename = `${operationType}_${timestamp}.pdf`;

    const options = {
      margin: 10,
      filename: filename,
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: { 
        scale: 2,
        useCORS: true,
        logging: false
      },
      jsPDF: { 
        unit: 'mm', 
        format: 'a4', 
        orientation: 'landscape' 
      }
    };

    // Ø¥Ù†Ø´Ø§Ø¡ PDF
    const pdf = html2pdf().set(options).from(exportElement);
    const pdfBlob = await pdf.output('blob');
    
    // Ø­ÙØ¸ Ù…Ø­Ù„ÙŠ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… blob
    const url = URL.createObjectURL(pdfBlob);
    const link = document.createElement('a');
    link.href = url;
    link.download = filename;
    link.click();
    URL.revokeObjectURL(url); // ØªØ­Ø±ÙŠØ± Ø§Ù„Ø°Ø§ÙƒØ±Ø©
    
    document.body.removeChild(exportElement);

    // Ø±ÙØ¹ Ø¥Ù„Ù‰ GitHub
    const uploadSuccess = await uploadIfAllowed(
      pdfBlob, 
      `exports/${filename}`,
      `ØªØµØ¯ÙŠØ± PDF ${operationType} Ù…Ù† Ù†Ø¸Ø§Ù… Ø§Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®ØªØ¨Ø± - ${new Date().toLocaleDateString('ar-EG')}`
    );
    
    showLoading(false);
    
    if (uploadSuccess) {
      notify('âœ… ØªÙ… ØªØµØ¯ÙŠØ± PDF ÙˆØ±ÙØ¹Ù‡ Ø¥Ù„Ù‰ GitHub Ø¨Ù†Ø¬Ø§Ø­', 'success');
    } else {
      notify('ğŸ’¾ ØªÙ… ØªØµØ¯ÙŠØ± PDF Ù…Ø­Ù„ÙŠØ§Ù‹ ÙÙ‚Ø·', 'success');
    }

  } catch (error) {
    console.error('Ø®Ø·Ø£ ÙÙŠ ØªØµØ¯ÙŠØ± PDF:', error);
    showLoading(false);
    notify('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù PDF', 'error');
  }
}
            
		/* ================= ØªØµØ¯ÙŠØ± Excel Ø¨Ù†ÙØ³ ØªÙ†Ø³ÙŠÙ‚ PDF ================= */
async function exportToExcel() {
  try {
    showLoading(true);

    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© ÙˆØ§Ù„ØªØ§Ø±ÙŠØ®
    const operationType = document.getElementById('operationType').value;
    const operationDate = document.getElementById('operationDate').value;
    
    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø¯ÙŠØ± ÙˆØ§Ù„Ù…Ø´Ø±Ù Ù…Ù† localStorage
    const directorInfo = getDirectorInfo();
    const supervisorInfo = getSupervisorInfo();
    
    const dateStr = new Date().toLocaleDateString('ar-EG');
    const workbook = new ExcelJS.Workbook();
    
    // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØµÙØ­Ø© Ø¨Ù†ÙØ³ ØªÙ†Ø³ÙŠÙ‚ PDF + RTL
    const worksheet = workbook.addWorksheet(operationType, {
      pageSetup: {
        paperSize: 9, // A4
        orientation: 'landscape',
        fitToPage: true,
        fitToWidth: 1,
        fitToHeight: 0,
        margins: {
          left: 0.7, right: 0.7,
          top: 0.7, bottom: 0.7,
          header: 0.3, footer: 0.3
        }
      },
      properties: {
        defaultColWidth: 15,
        defaultRowHeight: 20
      },
      // â­ ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙŠÙ…ÙŠÙ† Ù„Ù„ÙŠØ³Ø§Ø±
      views: [
        { rightToLeft: true }
      ]
    });

    // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø®Ø·ÙˆØ· - Ù†ÙØ³ ØªÙ†Ø³ÙŠÙ‚ PDF
    const titleFont = { name: 'Cairo', size: 16, bold: true, color: { argb: 'FF2B7BD3' } };
    const headerFont = { name: 'Cairo', size: 12, bold: true, color: { argb: 'FFFFFFFF' } };
    const normalFont = { name: 'Cairo', size: 10 };
    const smallFont = { name: 'Cairo', size: 9 };

    // === Ø§Ù„Ø±Ø£Ø³ - Ù†ÙØ³ ØªØµÙ…ÙŠÙ… PDF ===
    // Ø§Ù„ØµÙ 1: Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠ ÙÙŠ Ø³Ø·Ø±ÙŠÙ† - Ù…Ø«Ù„ PDF
    worksheet.mergeCells('A1:D1');
    const arabicLine1 = worksheet.getCell('A1');
    arabicLine1.value = 'Ø§Ù„Ø´Ø±ÙƒØ© Ø§Ù„Ø¯ÙˆÙ„ÙŠØ© Ø§Ù„Ø§ÙˆÙ„Ù‰';
    arabicLine1.font = { name: 'Cairo', size: 11, bold: true };
    arabicLine1.alignment = { horizontal: 'right', vertical: 'bottom' };

    worksheet.mergeCells('A2:D2');
    const arabicLine2 = worksheet.getCell('A2');
    arabicLine2.value = 'Ø§Ù„Ù…Ø­Ø¬Ø± Ø§Ù„ØµØ­ÙŠ Ø§Ù„ÙˆØ·Ù†ÙŠ Ø¨Ø±Ø¨Ø±Ø©';
    arabicLine2.font = { name: 'Cairo', size: 10 };
    arabicLine2.alignment = { horizontal: 'right', vertical: 'top' };

    // Ø§Ù„ØµÙ 1: Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ ÙÙŠ Ø³Ø·Ø±ÙŠÙ† - Ù…Ø«Ù„ PDF
    worksheet.mergeCells('I1:K1');
    const englishLine1 = worksheet.getCell('I1');
    englishLine1.value = 'PRIMA INTERNATIONAL COMPANY';
    englishLine1.font = { name: 'Cairo', size: 11, bold: true };
    englishLine1.alignment = { horizontal: 'left', vertical: 'bottom' };

    worksheet.mergeCells('I2:K2');
    const englishLine2 = worksheet.getCell('I2');
    englishLine2.value = 'BERBERA NATIONAL ANIMAL QUARANTINE';
    englishLine2.font = { name: 'Cairo', size: 10 };
    englishLine2.alignment = { horizontal: 'left', vertical: 'top' };

    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø´Ø¹Ø§Ø± Ø¨ÙŠÙ†Ù‡Ù…Ø§
    let logoBase64 = localStorage.getItem('labLogo');
    // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙˆØ¬Ø¯ Ø§Ù„Ø´Ø¹Ø§Ø± Ù…Ø­Ù„ÙŠÙ‹Ø§ØŒ Ø¬Ø±Ø¨Ù‡ Ù…Ù† GitHub
    if (!logoBase64 && window._inventorySessionToken) {
      logoBase64 = await loadLogoFromGitHub();
    }
    
    if (logoBase64) {
      try {
        const imageId = workbook.addImage({
          base64: logoBase64.split(',')[1],
          extension: 'png'
        });
        
        // Ø§Ù„Ø´Ø¹Ø§Ø± ÙŠØºØ·ÙŠ Ø§Ù„ØµÙÙŠÙ† 1 Ùˆ 2 ÙÙŠ Ø§Ù„Ø¹Ù…ÙˆØ¯ G
        worksheet.addImage(imageId, {
          tl: { col: 6, row: 0 },  // Ø§Ù„Ø¹Ù…ÙˆØ¯ G (6)ØŒ Ø§Ù„ØµÙ 1 (0)
          br: { col: 7, row: 2 }   // Ø¥Ù„Ù‰ Ø§Ù„Ø¹Ù…ÙˆØ¯ G (7)ØŒ Ø§Ù„ØµÙ 3 (2)
        });
        
        worksheet.mergeCells('G1:G2');
        
      } catch (e) {
        console.warn('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø´Ø¹Ø§Ø± Ø¥Ù„Ù‰ Excel:', e);
        worksheet.mergeCells('G1:G2');
        const logoCell = worksheet.getCell('G1');
        logoCell.value = '[Ø´Ø¹Ø§Ø± Ø§Ù„Ø´Ø±ÙƒØ©]';
        logoCell.font = { name: 'Cairo', size: 9, color: { argb: 'FF666666' } };
        logoCell.alignment = { horizontal: 'center', vertical: 'middle' };
      }
    } else {
      worksheet.mergeCells('G1:G2');
      const logoCell = worksheet.getCell('G1');
      logoCell.value = 'Ø¨Ø¯ÙˆÙ† Ø´Ø¹Ø§Ø±';
      logoCell.font = { name: 'Cairo', size: 9, color: { argb: 'FF999999' } };
      logoCell.alignment = { horizontal: 'center', vertical: 'middle' };
    }

    // Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ ÙŠØ¨Ø¯Ø£ Ù…Ù† Ø§Ù„ØµÙ 4
    worksheet.mergeCells('A4:K4');
    const mainTitle = worksheet.getCell('A4');
    mainTitle.value = 'Ù†Ø¸Ø§Ù… Ø§Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®ØªØ¨Ø±';
    mainTitle.font = { name: 'Cairo', size: 16, bold: true, color: { argb: 'FF2B7BD3' } };
    mainTitle.alignment = { horizontal: 'center', vertical: 'middle' };

    // Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙØ±Ø¹ÙŠ ÙÙŠ Ø§Ù„ØµÙ 5
    worksheet.mergeCells('A5:K5');
    const subTitle = worksheet.getCell('A5');
    subTitle.value = `${operationType} Ù…Ø´Ø®ØµØ§Øª ÙˆÙ„Ù‚Ø§Ø­Ø§Øª Ø§Ù„Ù…Ø®ØªØ¨Ø±`;
    subTitle.font = { name: 'Cairo', size: 14, bold: true };
    subTitle.alignment = { horizontal: 'center', vertical: 'middle' };

    // ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¬Ø±Ø¯ ÙÙŠ Ø§Ù„ØµÙ 6
    worksheet.mergeCells('A6:K6');
    const dateCell = worksheet.getCell('A6');
    dateCell.value = `ØªØ§Ø±ÙŠØ® ${operationType}: ${operationDate}`;
    dateCell.font = { name: 'Cairo', size: 12, bold: true };
    dateCell.alignment = { horizontal: 'center', vertical: 'middle' };

    // ØµÙ ÙØ§Ø±Øº Ù‚Ø¨Ù„ Ø§Ù„Ø¬Ø¯ÙˆÙ„
    worksheet.addRow([]);

    // === Ø±Ø¤ÙˆØ³ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© - Ù†ÙØ³ ØªÙ†Ø³ÙŠÙ‚ PDF ===
    const headers = ['Ù…', 'Ø§Ù„ØµÙˆØ±Ø©', 'Ø§Ù„Ù†ÙˆØ¹', 'Ø§Ù„Ø§Ø³Ù…', 'Ø§Ù„ÙƒÙ…ÙŠØ©', 'Ø§Ù„ÙˆØ­Ø¯Ø©', 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡', 'Ø§Ù„Ø´Ø±ÙƒØ©', 'Ø±Ù‚Ù… Ø§Ù„ØªØ´ØºÙŠÙ„Ø©', 'Ø±Ù‚Ù… Ø§Ù„Ù…Ù†ØªØ¬', 'Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª'];
    const headerRow = worksheet.addRow(headers);
    
    // ØªÙ†Ø³ÙŠÙ‚ Ø±Ø¤ÙˆØ³ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©
    headerRow.eachCell((cell, colNumber) => {
      cell.font = headerFont;
      cell.fill = {
        type: 'pattern',
        pattern: 'solid',
        fgColor: { argb: 'FF2B7BD3' } // Ù†ÙØ³ Ù„ÙˆÙ† PDF
      };
      cell.border = {
        top: { style: 'thin', color: { argb: 'FF000000' } },
        left: { style: 'thin', color: { argb: 'FF000000' } },
        bottom: { style: 'thin', color: { argb: 'FF000000' } },
        right: { style: 'thin', color: { argb: 'FF000000' } }
      };
      cell.alignment = { 
        horizontal: 'center', 
        vertical: 'middle',
        wrapText: true
      };
    });

    // === ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¹ Ø§Ù„ØµÙˆØ± ===
    let imageCounter = 0;
    
    for (let index = 0; index < currentInventory.length; index++) {
      const item = currentInventory[index];
      const rowNumber = headerRow.number + 1 + index;
      
      // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµÙˆØ±Ø© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
      if (item.image && item.image.startsWith('data:image')) {
        try {
          // ØªØ­ÙˆÙŠÙ„ base64 Ø¥Ù„Ù‰ buffer
          const base64Data = item.image.split(',')[1];
          const imageBuffer = Uint8Array.from(atob(base64Data), c => c.charCodeAt(0));
          
          // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµÙˆØ±Ø© Ø¥Ù„Ù‰ Ø§Ù„Ù…ØµÙ†Ù
          const imageId = workbook.addImage({
            buffer: imageBuffer,
            extension: item.image.includes('png') ? 'png' : 'jpeg'
          });
          
          // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµÙˆØ±Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø®Ù„ÙŠØ© B (Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø«Ø§Ù†ÙŠ)
          worksheet.addImage(imageId, {
            tl: { col: 1, row: rowNumber - 1 }, // Ø§Ù„Ø¹Ù…ÙˆØ¯ B (1)ØŒ Ø§Ù„ØµÙ Ø§Ù„Ø­Ø§Ù„ÙŠ
            br: { col: 2, row: rowNumber },     // Ø¥Ù„Ù‰ Ø§Ù„Ø¹Ù…ÙˆØ¯ C (2)ØŒ Ø§Ù„ØµÙ Ø§Ù„ØªØ§Ù„ÙŠ
            editAs: 'oneCell'
          });
          
          imageCounter++;
        } catch (e) {
          console.warn('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© ØµÙˆØ±Ø© Ø§Ù„Ù…Ù†ØªØ¬:', e);
        }
      }
      
      // Ø¥Ø¶Ø§ÙØ© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØµÙ
      const row = worksheet.addRow([
        index + 1,
        item.image ? '' : '---', // ØªØ±Ùƒ Ø§Ù„Ø®Ù„ÙŠØ© ÙØ§Ø±ØºØ© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù‡Ù†Ø§Ùƒ ØµÙˆØ±Ø©
        item.type,
        item.name,
        item.quantity,
        item.unit,
        formatExpiryDate(item.expiry),
        item.company || '-',
        item.batch || '-',
        item.product || '-',
        item.notes || '-'
      ]);

      // Ø¶Ø¨Ø· Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„ØµÙ Ù„Ø§Ø³ØªÙŠØ¹Ø§Ø¨ Ø§Ù„ØµÙˆØ±Ø©
      row.height = 60;

      // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØµÙ
      row.eachCell((cell, colNumber) => {
        cell.font = normalFont;
        cell.border = {
          top: { style: 'thin', color: { argb: 'FFDDDDDD' } },
          left: { style: 'thin', color: { argb: 'FFDDDDDD' } },
          bottom: { style: 'thin', color: { argb: 'FFDDDDDD' } },
          right: { style: 'thin', color: { argb: 'FFDDDDDD' } }
        };
        cell.alignment = { 
          horizontal: 'center', 
          vertical: 'middle',
          wrapText: true
        };

        // Ù…Ø­Ø§Ø°Ø§Ø© Ø®Ø§ØµØ© Ù„Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù†ØµÙŠØ©
        if (colNumber === 4) { // Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø§Ø³Ù…
          cell.alignment = { horizontal: 'right', vertical: 'middle', wrapText: true };
        }
        if (colNumber === 11) { // Ø¹Ù…ÙˆØ¯ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª
          cell.alignment = { horizontal: 'right', vertical: 'middle', wrapText: true };
        }
      });

      // ØªÙ„ÙˆÙŠÙ† Ø§Ù„ØµÙÙˆÙ Ø¨Ù†ÙØ³ Ø£Ù„ÙˆØ§Ù† PDF
      if (checkIfExpired(item.expiry)) {
        row.fill = {
          type: 'pattern',
          pattern: 'solid',
          fgColor: { argb: 'FFFFEBEE' } // Ø£Ø­Ù…Ø± ÙØ§ØªØ­
        };
      } else if (parseInt(item.quantity) < 10) {
        row.fill = {
          type: 'pattern',
          pattern: 'solid',
          fgColor: { argb: 'FFFFF3E0' } // Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ ÙØ§ØªØ­
        };
      }

      // ØªÙ„ÙˆÙŠÙ† ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…Ù†ØªÙ‡ÙŠÙ‹Ø§
      const expiryCell = row.getCell(7);
      if (checkIfExpired(item.expiry)) {
        expiryCell.font = { name: 'Cairo', size: 10, bold: true, color: { argb: 'FFE74C3C' } };
      }
    }

    // === Ø¶Ø¨Ø· Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© - Ù†ÙØ³ Ù†Ø³Ø¨ PDF ===
    worksheet.columns = [
      { width: 5 },   // Ù… (3%)
      { width: 15 },  // Ø§Ù„ØµÙˆØ±Ø© (7%) - Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø¹Ø±Ø¶ Ù„Ø§Ø³ØªÙŠØ¹Ø§Ø¨ Ø§Ù„ØµÙˆØ±
      { width: 10 },  // Ø§Ù„Ù†ÙˆØ¹ (8%)
      { width: 25 },  // Ø§Ù„Ø§Ø³Ù… (15%)
      { width: 8 },   // Ø§Ù„ÙƒÙ…ÙŠØ© (5%)
      { width: 10 },  // Ø§Ù„ÙˆØ­Ø¯Ø© (6%)
      { width: 12 },  // ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ (8%)
      { width: 15 },  // Ø§Ù„Ø´Ø±ÙƒØ© (10%)
      { width: 12 },  // Ø±Ù‚Ù… Ø§Ù„ØªØ´ØºÙŠÙ„Ø© (8%)
      { width: 12 },  // Ø±Ù‚Ù… Ø§Ù„Ù…Ù†ØªØ¬ (10%)
      { width: 30 }   // Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª (20%)
    ];

    // Ø¶Ø¨Ø· Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„ØµÙÙˆÙ
    worksheet.getRow(1).height = 25;
    worksheet.getRow(4).height = 30;
    worksheet.getRow(5).height = 25;
    worksheet.getRow(6).height = 25;
    headerRow.height = 30;

    // === Ø§Ù„ØªÙˆÙ‚ÙŠØ¹Ø§Øª - Ù…Ø¹ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ ===
    const lastRow = worksheet.lastRow.number + 2;

    // ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ø´Ø±Ù Ù…Ø¹ Ø§Ù„Ø§Ø³Ù…
    worksheet.mergeCells(`A${lastRow}:E${lastRow}`);
    const supervisorTitle = worksheet.getCell(`A${lastRow}`);
    supervisorTitle.value = 'ØªÙˆÙ‚ÙŠØ¹ Ù…Ø´Ø±Ù Ø§Ù„Ù…Ø®ØªØ¨Ø±';
    supervisorTitle.font = { name: 'Cairo', size: 12, bold: true, color: { argb: 'FF000000' } }; // Ø£Ø³ÙˆØ¯
    supervisorTitle.alignment = { horizontal: 'center', vertical: 'middle' };

    worksheet.mergeCells(`A${lastRow + 1}:E${lastRow + 1}`);
    const supervisorName = worksheet.getCell(`A${lastRow + 1}`);
    supervisorName.value = supervisorInfo.name;
    supervisorName.font = { name: 'Cairo', size: 11, color: { argb: 'FF000000' } }; // Ø£Ø³ÙˆØ¯
    supervisorName.alignment = { horizontal: 'center', vertical: 'middle' };

    // Ø¥Ø¶Ø§ÙØ© ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ø´Ø±Ù Ø¥Ø°Ø§ Ù…ÙˆØ¬ÙˆØ¯
    if (supervisorInfo.signature) {
      try {
        const supervisorSigBase64 = supervisorInfo.signature.split(',')[1];
        const supervisorSigBuffer = Uint8Array.from(atob(supervisorSigBase64), c => c.charCodeAt(0));
        const supervisorSigId = workbook.addImage({
          buffer: supervisorSigBuffer,
          extension: 'png'
        });
        
        worksheet.addImage(supervisorSigId, {
          tl: { col: 1, row: lastRow - 1 }, // Ø§Ù„Ø¹Ù…ÙˆØ¯ B
          br: { col: 3, row: lastRow },     // Ø¥Ù„Ù‰ Ø§Ù„Ø¹Ù…ÙˆØ¯ D
          editAs: 'oneCell'
        });
      } catch (e) {
        console.warn('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ø´Ø±Ù:', e);
      }
    }

    // ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ø¯ÙŠØ± Ù…Ø¹ Ø§Ù„Ø§Ø³Ù…
    worksheet.mergeCells(`G${lastRow}:K${lastRow}`);
    const directorTitle = worksheet.getCell(`G${lastRow}`);
    directorTitle.value = 'ØªÙˆÙ‚ÙŠØ¹ Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø®ØªØ¨Ø±';
    directorTitle.font = { name: 'Cairo', size: 12, bold: true, color: { argb: 'FF000000' } }; // Ø£Ø³ÙˆØ¯
    directorTitle.alignment = { horizontal: 'center', vertical: 'middle' };

    worksheet.mergeCells(`G${lastRow + 1}:K${lastRow + 1}`);
    const directorName = worksheet.getCell(`G${lastRow + 1}`);
    directorName.value = directorInfo.name;
    directorName.font = { name: 'Cairo', size: 11, color: { argb: 'FF000000' } }; // Ø£Ø³ÙˆØ¯
    directorName.alignment = { horizontal: 'center', vertical: 'middle' };

    // Ø¥Ø¶Ø§ÙØ© ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ø¯ÙŠØ± Ø¥Ø°Ø§ Ù…ÙˆØ¬ÙˆØ¯
    if (directorInfo.signature) {
      try {
        const directorSigBase64 = directorInfo.signature.split(',')[1];
        const directorSigBuffer = Uint8Array.from(atob(directorSigBase64), c => c.charCodeAt(0));
        const directorSigId = workbook.addImage({
          buffer: directorSigBuffer,
          extension: 'png'
        });
        
        worksheet.addImage(directorSigId, {
          tl: { col: 7, row: lastRow - 1 }, // Ø§Ù„Ø¹Ù…ÙˆØ¯ H
          br: { col: 9, row: lastRow },     // Ø¥Ù„Ù‰ Ø§Ù„Ø¹Ù…ÙˆØ¯ J
          editAs: 'oneCell'
        });
      } catch (e) {
        console.warn('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ø¯ÙŠØ±:', e);
      }
    }

    // === Ø§Ù„ØªØ°ÙŠÙŠÙ„ - Ù†ÙØ³ ØªÙ†Ø³ÙŠÙ‚ PDF ===
    const footerRow = lastRow + 3;
    worksheet.mergeCells(`A${footerRow}:K${footerRow}`);
    const footer = worksheet.getCell(`A${footerRow}`);
    footer.value = `ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù‡Ø°Ø§ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¨ÙˆØ§Ø³Ø·Ø© Ù†Ø¸Ø§Ù… Ø§Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®ØªØ¨Ø± - Laboratory Management System 2025 ${imageCounter > 0 ? `(ØªÙ… Ø¥Ø¶Ø§ÙØ© ${imageCounter} ØµÙˆØ±Ø©)` : ''}`;
    footer.font = smallFont;
    footer.alignment = { horizontal: 'center', vertical: 'middle' };
    footer.fill = {
      type: 'pattern',
      pattern: 'solid',
      fgColor: { argb: 'FFF5F5F5' }
    };

    // Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù
    const buffer = await workbook.xlsx.writeBuffer();
    const blob = new Blob([buffer], {
      type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
    });

    // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù Ù…Ø¹ Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª
    const now = new Date();
    const timestamp = `${now.getFullYear()}-${(now.getMonth()+1).toString().padStart(2,'0')}-${now.getDate().toString().padStart(2,'0')}_${now.getHours().toString().padStart(2,'0')}-${now.getMinutes().toString().padStart(2,'0')}`;
    const filename = `${operationType}_${timestamp}.xlsx`;

    // Ø­ÙØ¸ Ù…Ø­Ù„ÙŠ
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = filename;
    link.click();

    const uploadSuccess = await uploadIfAllowed(
      blob, 
      `exports/${filename}`,
      `ØªØµØ¯ÙŠØ± Excel ${operationType} Ù…Ù† Ù†Ø¸Ø§Ù… Ø§Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®ØªØ¨Ø± - ${new Date().toLocaleDateString('ar-EG')}`
    );

    showLoading(false);

    if (uploadSuccess) {
      notify(`âœ… ØªÙ… ØªØµØ¯ÙŠØ± Excel Ù…Ø¹ ${imageCounter} ØµÙˆØ±Ø© ÙˆØ±ÙØ¹Ù‡ Ø¥Ù„Ù‰ GitHub Ø¨Ù†Ø¬Ø§Ø­`, 'success');
    } else {
      notify(`ğŸ’¾ ØªÙ… ØªØµØ¯ÙŠØ± Excel Ù…Ø¹ ${imageCounter} ØµÙˆØ±Ø© Ù…Ø­Ù„ÙŠØ§Ù‹ ÙÙ‚Ø·`, 'success');
    }

  } catch (error) {
    console.error('Ø®Ø·Ø£ ÙÙŠ ØªØµØ¯ÙŠØ± Excel:', error);
    showLoading(false);
    notify('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Excel', 'error');
  }
}
    function printTable(){ window.print(); }

    // Sample data and clear
    function addSampleData(){ 
      const sample = [ 
        {type:'Ù„Ù‚Ø§Ø­',name:'Ù„Ù‚Ø§Ø­ Ø§Ù„Ø­Ù…Ù‰ Ø§Ù„Ù‚Ù„Ø§Ø¹ÙŠØ©',quantity:50,unit:'Ù‚Ø§Ø±ÙˆØ±Ø©',expiry:'2026-06',company:'Ø´Ø±ÙƒØ© Ø£',batch:'B123'},
        {type:'Ù…Ø´Ø®ØµØ§Øª Ø§Ù„ÙŠØ²Ø§',name:'Rift valley competition elisa',quantity:5,unit:'Ø¨Ø§ÙƒØª',expiry:'2024-12',company:'Ù…Ø®ØªØ¨Ø± Ø¨',batch:'EL-01'} 
      ]; 
      sample.forEach(s=>{ 
        db.run('INSERT INTO inventory (type,name,quantity,unit,expiry,company,batch) VALUES (?,?,?,?,?,?,?)',
          [s.type,s.name,s.quantity,s.unit,s.expiry,s.company,s.batch]); 
      }); 
      saveDatabaseToStorage(); 
      loadInventory(); 
      notify('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ©','success'); 
    }
    
    function clearData(){ 
      if(confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ')){ 
        db.run('DELETE FROM inventory'); 
        saveDatabaseToStorage(); 
        loadInventory(); 
        notify('ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª','success'); 
      } 
    }

    // Theme
    function toggleTheme(){ 
      document.documentElement.classList.toggle('dark-theme'); 
      localStorage.setItem('theme', document.documentElement.classList.contains('dark-theme')? 'dark':'light'); 
    }
    
    function loadTheme(){ 
      const t = localStorage.getItem('theme') || 'light'; 
      if(t==='dark') document.documentElement.classList.add('dark-theme'); 
    }

    // Utilities
    function todayDateString(){ const d=new Date(); return d.toISOString().slice(0,10); }

    // Notifications
    let notifTimer = null;
    function notify(message,type='success'){ 
      const n=document.getElementById('notification'); 
      const msg=document.getElementById('notificationMessage'); 
      msg.textContent = message; 
      n.classList.add('show'); 
      if(type==='error') n.style.backgroundColor='var(--danger)'; 
      else if(type==='warning') n.style.backgroundColor='var(--warning)'; 
      else n.style.backgroundColor='var(--success)'; 
      clearTimeout(notifTimer); 
      notifTimer = setTimeout(()=> hideNotification(), 4000); 
    }
    
    function hideNotification(){ 
      const n=document.getElementById('notification'); 
      n.classList.remove('show'); 
    }

    function showLoading(state){ 
      const l=document.getElementById('loadingOverlay'); 
      if(state) l.classList.add('show'); 
      else l.classList.remove('show'); 
    }

    // --- Save mode (local / github / both) helpers ---
    function getSaveMode(){
      return localStorage.getItem('inventory_save_mode') || 'both';
    }
    
    function applySaveModeToUI(){
      const mode = getSaveMode();
      document.getElementById('saveLocal').checked = mode==='local';
      document.getElementById('saveGithub').checked = mode==='github';
      document.getElementById('saveBoth').checked = mode==='both';
      const hint = document.getElementById('saveModeHint');
      if(mode==='local') hint.textContent = 'Ø³ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ù„ÙØ§Øª Ù…Ø­Ù„ÙŠÙ‹Ø§ ÙÙ‚Ø·.';
      else if(mode==='github') hint.textContent = 'Ø³ÙŠØªÙ… Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª Ø¥Ù„Ù‰ GitHub ÙÙ‚Ø·.';
      else hint.textContent = 'Ø³ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ù„ÙØ§Øª Ù…Ø­Ù„ÙŠÙ‹Ø§ ÙˆØ±ÙØ¹Ù‡Ø§ Ø¥Ù„Ù‰ GitHub.';
    }
    
    function setSaveMode(mode){
      localStorage.setItem('inventory_save_mode', mode);
      applySaveModeToUI();
      notify('ØªÙ… ØªØºÙŠÙŠØ± ÙˆØ¶Ø¹ Ø§Ù„Ø­ÙØ¸ Ø¥Ù„Ù‰: ' + (mode==='both'?'Ù…Ø­Ù„ÙŠ + GitHub': mode==='local'?'Ù…Ø­Ù„ÙŠ ÙÙ‚Ø·':'GitHub ÙÙ‚Ø·'), 'success');
    }

    // GitHub connection
    async function testGithubConnection(){
      const statusEl = document.getElementById('testGithubStatus');
      statusEl.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...';
      try{
        const tokenInputEl = document.getElementById('githubTokenInput');
        if(tokenInputEl && tokenInputEl.value && tokenInputEl.value.trim()!==''){
          window._inventorySessionToken = tokenInputEl.value.trim();
          localStorage.setItem('inventory_github_token', window._inventorySessionToken);
        } else {
          const saved = localStorage.getItem('inventory_github_token');
          if(saved) window._inventorySessionToken = saved;
        }

        if(!window._inventorySessionToken){ 
          statusEl.textContent = 'Ù„Ù… ÙŠØªÙ… Ø¥Ø¯Ø®Ø§Ù„ ØªÙˆÙƒÙ† Ø§Ù„Ø¬Ù„Ø³Ø©.'; 
          notify('Ù„Ù… ÙŠØªÙ… Ø¥Ø¯Ø®Ø§Ù„ ØªÙˆÙƒÙ† Ø§Ù„Ø¬Ù„Ø³Ø©','error'); 
          return false; 
        }

        const url = `https://api.github.com/repos/${window._inventoryGithubOwner}/${window._inventoryGithubRepo}`;
        const res = await fetch(url, { 
          headers: { 
            'Authorization': 'Bearer ' + window._inventorySessionToken, 
            'Accept':'application/vnd.github.v3+json' 
          } 
        });

        if(res.ok){
          statusEl.textContent = 'âœ… ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹.';
          notify('ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ GitHub Ø¨Ù†Ø¬Ø§Ø­', 'success');
          return true;
        } else {
          let body = '';
          try { body = await res.text(); } catch(e){ body = ''; }
          let reason = '';
          if(res.status===401) reason = 'Ø±Ù…Ø² Ø§Ù„ØªÙˆÙƒÙ† ØºÙŠØ± ØµØ§Ù„Ø­ Ø£Ùˆ Ù…Ù†ØªÙ‡ÙŠ (401 Unauthorized).';
          else if(res.status===403) reason = 'Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ÙˆØµÙˆÙ„ Ø£Ùˆ ØªÙ… Ø­Ø¸Ø± Ø§Ù„Ø·Ù„Ø¨ (403 Forbidden).';
          else if(res.status===404) reason = 'Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ Ø£Ùˆ Ø§Ù„Ù…Ø³Ø§Ø± Ø®Ø§Ø·Ø¦ (404 Not Found).';
          else reason = `Ø®Ø·Ø£: (${res.status})`;
          statusEl.textContent = 'âŒ ' + reason;
          notify('ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ GitHub: ' + reason, 'error');
          console.error('testGithubConnection fail', res.status, body);
          return false;
        }
      }catch(e){
        statusEl.textContent = 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„: ' + (e && e.message ? e.message : e);
        notify('Ø®Ø·Ø£ ÙÙŠ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„: ' + (e && e.message ? e.message : e), 'error');
        console.error(e);
        return false;
      }
    }

    // Auto GitHub upload - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø­Ø³Ù†Ø©
    async function uploadToGitHub(blob, pathInRepo, message) {
        console.log('ğŸ“± Ø¨Ø¯Ø¡ Ø§Ù„Ø±ÙØ¹ Ù…Ù† Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„...');
        
        if (!window._inventorySessionToken) {
            console.error('âŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªÙˆÙƒÙ†');
            notify('âŒ Ù„Ù… ÙŠØªÙ… Ø¥Ø¯Ø®Ø§Ù„ ØªÙˆÙƒÙ† GitHub', 'error');
            return false;
        }

        try {
            // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù€ Blob Ø¥Ù„Ù‰ base64
            const arrayBuffer = await blob.arrayBuffer();
            const uint8Array = new Uint8Array(arrayBuffer);
            let binary = '';
            uint8Array.forEach(byte => {
                binary += String.fromCharCode(byte);
            });
            const base64 = btoa(binary);

            const url = `https://api.github.com/repos/${window._inventoryGithubOwner}/${window._inventoryGithubRepo}/contents/${pathInRepo}`;
            
            console.log('ğŸ“¤ Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹:', pathInRepo);

            let sha = null;
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…Ù„Ù
            try {
                const getRes = await fetch(url, { 
                    method: 'GET', 
                    headers: { 
                        'Authorization': 'Bearer ' + window._inventorySessionToken, 
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (getRes.ok) {
                    const fileData = await getRes.json();
                    sha = fileData.sha;
                    console.log('ğŸ“„ Ø§Ù„Ù…Ù„Ù Ù…ÙˆØ¬ÙˆØ¯ - Ø³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ«Ù‡');
                }
            } catch (e) {
                console.log('ğŸ“„ Ø§Ù„Ù…Ù„Ù ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ - Ø³ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¤Ù‡');
            }

            const body = { 
                message: message || (`Ø±ÙØ¹ ${pathInRepo} Ù…Ù† Ù†Ø¸Ø§Ù… Ø§Ø¯Ø§Ø±Ø©Ø§Ù„Ù…Ø®ØªØ¨Ø±`), 
                content: base64,
                branch: 'main'
            };
            
            if (sha) body.sha = sha;

            const putRes = await fetch(url, {
                method: 'PUT',
                headers: { 
                    'Authorization': 'Bearer ' + window._inventorySessionToken, 
                    'Content-Type': 'application/json',
                    'Accept': 'application/vnd.github.v3+json'
                },
                body: JSON.stringify(body)
            });

            console.log('ğŸ“© Ø§Ø³ØªØ¬Ø§Ø¨Ø© GitHub:', putRes.status);

            if (putRes.ok) {
                console.log('âœ… ØªÙ… Ø§Ù„Ø±ÙØ¹ Ø¨Ù†Ø¬Ø§Ø­');
                return true;
            } else {
                const errorText = await putRes.text();
                console.error('âŒ ÙØ´Ù„ Ø§Ù„Ø±ÙØ¹:', putRes.status, errorText);
                
                // Ø±Ø³Ø§Ø¦Ù„ Ù…Ø¨Ø³Ø·Ø© Ù„Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„
                let errorMessage = 'ÙØ´Ù„ Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù';
                if (putRes.status === 401) errorMessage = 'Ø§Ù„ØªÙˆÙƒÙ† Ù…Ù†ØªÙ‡ÙŠ Ø£Ùˆ ØºÙŠØ± ØµØ§Ù„Ø­';
                else if (putRes.status === 403) errorMessage = 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ù„Ø±ÙØ¹';
                else if (putRes.status === 404) errorMessage = 'Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯';
                
                notify(`âŒ ${errorMessage}`, 'error');
                return false;
            }
        } catch (err) {
            console.error('ğŸš¨ Ø®Ø·Ø£:', err);
            notify('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø±ÙØ¹', 'error');
            return false;
        }
    }

    async function uploadIfAllowed(blob, path, msg){
        const mode = getSaveMode();
        const hasToken = !!window._inventorySessionToken;
        
        console.log('ğŸ” ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø±ÙØ¹:', {
            mode: mode,
            hasToken: hasToken,
            path: path,
            fileSize: blob.size
        });
        
        if(mode === 'local'){ 
            console.log('ğŸ’¾ Save mode is local - skipping GitHub upload'); 
            return false; 
        }
        
        if(!hasToken){ 
            notify('âŒ Ù„Ù… ÙŠØªÙ… Ø¥Ø¯Ø®Ø§Ù„ ØªÙˆÙƒÙ† GitHub - ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù Ù…Ø­Ù„ÙŠÙ‹Ø§ ÙÙ‚Ø·','warning'); 
            return false; 
        }
        
        // Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØªÙˆÙƒÙ† Ø£ÙˆÙ„Ø§Ù‹
        const tokenValid = await testGithubConnection();
        if (!tokenValid) {
            notify('âŒ Ø§Ù„ØªÙˆÙƒÙ† ØºÙŠØ± ØµØ§Ù„Ø­ - ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù Ù…Ø­Ù„ÙŠÙ‹Ø§ ÙÙ‚Ø·', 'error');
            return false;
        }
        
        return await uploadToGitHub(blob, path, msg);
    }
  </script>
</body>
</html>
